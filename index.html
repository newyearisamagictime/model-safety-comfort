<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Life Parameters Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --toast-bg: #0f0f23;
            --toast-text: #e5e7eb;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        html, body {
            height: 100%;
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        body {
            background: var(--dark-gradient);
            color: #e5e7eb;
        }
        .glass-morphism {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }
        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .ai-glow {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
        }
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 5;
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(20px);
        }
        /* Ensure sticky columns have a background in both standard and transposed views */
        .transposed-table .sticky-col, .standard-table .sticky-col {
             background: rgba(26, 26, 46, 0.8) !important;
             backdrop-filter: blur(20px);
        }
         .transposed-table tr:hover .sticky-col, .standard-table tr:hover .sticky-col {
             background: rgba(102, 126, 234, 0.2) !important;
        }

        .sticky-col-header {
            position: sticky;
            left: 0;
            z-index: 15;
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
        }
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            color: var(--toast-text);
            padding: 16px 32px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            font-weight: 500;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Modern button styles */
        .ai-button {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .ai-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        .ai-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .ai-button:hover:before {
            left: 100%;
        }

        /* Styles for showing text or input in a cell */
        .score-cell .score-input {
            display: none;
            background: rgba(15, 15, 35, 0.8);
            color: #e5e7eb;
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 8px;
        }
        .score-cell.editing .score-text {
            display: none;
        }
        .score-cell.editing .score-input {
            display: block;
        }
        
        /* Modern disabled button styles */
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        button:disabled:hover {
            color: inherit !important;
        }

        /* Modern table styles */
        .modern-table {
            background: transparent;
        }
        .modern-table th {
            background: rgba(15, 15, 35, 0.9);
            color: #a855f7;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            padding: 16px 12px;
        }
        .modern-table td {
            background: rgba(26, 26, 46, 0.6);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        .modern-table tr:hover td {
            background: rgba(102, 126, 234, 0.1);
        }

        /* Modern form elements */
        .modern-input {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            color: #e5e7eb;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }
        .modern-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            outline: none;
        }
        .modern-input::placeholder {
            color: #6b7280;
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(26, 26, 46, 0.3);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
        }

        /* Enhanced animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Pulse animation for AI elements */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 0 50px rgba(102, 126, 234, 0.5);
            }
        }
        .pulse-glow {
            animation: pulse-glow 3s ease-in-out infinite;
        }

        /* Icon styles */
        .ai-icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
            transition: all 0.3s ease;
        }
        .ai-icon:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="flex flex-wrap justify-between items-center mb-8 gap-y-6">
            <div class="flex items-center space-x-4 w-full md:w-auto">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center ai-glow pulse-glow">
                    <i data-lucide="brain-circuit" class="ai-icon text-white"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold gradient-text fade-in-up">AI Life Parameters Analyzer</h1>
            </div>
            <div class="flex items-center space-x-3 flex-wrap gap-3">
                 <button id="transpose-btn" class="ai-button hover-lift flex items-center space-x-2">
                    <i data-lucide="rotate-cw" class="ai-icon"></i>
                    <span data-lang-key="transpose_table">Transpose</span>
                </button>
                <button id="edit-params-btn" class="ai-button hover-lift flex items-center space-x-2">
                    <i data-lucide="settings" class="ai-icon"></i>
                    <span data-lang-key="edit_parameters">Edit Parameters</span>
                </button>
                <button id="export-btn" class="ai-button hover-lift flex items-center space-x-2">
                    <i data-lucide="download" class="ai-icon"></i>
                    <span data-lang-key="export_json">Export JSON</span>
                </button>
                <label for="import-file" class="ai-button hover-lift flex items-center space-x-2 cursor-pointer">
                    <i data-lucide="upload" class="ai-icon"></i>
                    <span data-lang-key="import_json">Import JSON</span>
                    <input type="file" id="import-file" class="hidden" accept=".json">
                </label>
            </div>
        </header>

        <!-- Search / Filter -->
        <div class="mb-6">
            <div class="relative max-w-md">
                <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 ai-icon"></i>
                <input id="search-box" type="text" placeholder="Filter options..." data-lang-placeholder="filter_options" class="modern-input w-full pl-12">
            </div>
        </div>

        <!-- Main Table -->
        <div id="table-container" class="table-container glass-morphism ai-glow mb-6">
            <table id="main-table" class="modern-table w-full text-left">
                <thead id="table-header">
                    <!-- Header will be dynamically generated -->
                </thead>
                <tbody id="table-body">
                    <!-- Body will be dynamically generated -->
                </tbody>
            </table>
        </div>
        <div class="mt-6">
            <button id="add-option-btn" class="ai-button hover-lift flex items-center space-x-2">
                <i data-lucide="plus" class="ai-icon"></i>
                <span data-lang-key="add_option">Add Option</span>
            </button>
        </div>

    </div>

    <!-- Parameter Editor Modal -->
    <div id="param-editor-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full hidden z-20">
        <div class="relative top-20 mx-auto p-6 border-0 w-full max-w-4xl shadow-2xl rounded-2xl glass-morphism ai-glow">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center">
                        <i data-lucide="sliders-horizontal" class="ai-icon text-white w-4 h-4"></i>
                    </div>
                    <h3 class="text-2xl font-bold gradient-text" data-lang-key="parameter_editor">Parameter Editor</h3>
                </div>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-200 text-2xl font-bold w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-700 transition-colors">&times;</button>
            </div>
            <div id="param-list" class="space-y-6 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">
                <!-- Parameter items will be dynamically generated -->
            </div>
            <div class="mt-8 flex justify-between">
                <button id="add-param-btn" class="ai-button hover-lift flex items-center space-x-2" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i data-lucide="plus-circle" class="ai-icon"></i>
                    <span data-lang-key="add_parameter">Add Parameter</span>
                </button>
                <button id="save-params-btn" class="ai-button hover-lift flex items-center space-x-2">
                    <i data-lucide="save" class="ai-icon"></i>
                    <span data-lang-key="save_and_close">Save & Close</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast-notification"></div>

    <script type="module">
        // Initialize Lucide icons
        lucide.createIcons();
        // --- DATA AND STATE MANAGEMENT ---
        const state = {
            lang: 'ru', // Default to Russian
            isTransposed: false,
            parameters: [],
            options: [],
            colorMap: new Map(),
            descriptionMap: new Map(),
        };

        const i18n = {
            en: {
                edit_parameters: "Edit Parameters",
                export_json: "Export JSON",
                import_json: "Import JSON",
                transpose_table: "Transpose",
                filter_options: "Filter options by name...",
                option_name: "Option Name",
                notes_price: "Notes / Price",
                actions: "Actions",
                add_option: "Add Option",
                parameter_editor: "Parameter Editor",
                add_parameter: "Add Parameter",
                save_and_close: "Save & Close",
                delete: "Delete",
                clone: "Clone",
                score: "Score",
                color: "Color",
                description: "Description",
                parameter_name: "Parameter Name",
                parameter: "Parameter",
                new_option_name: "New Option",
                new_option_notes: "Notes...",
                new_parameter_name: "New Parameter",
                default_palette_desc: "Description for score",
                import_success: "Data imported successfully!",
                import_error: "Failed to read or parse JSON file.",
                changes_saved: "Changes saved automatically.", // This message is no longer shown, but kept for i18n
                no_params_title: "No Parameters Found",
                no_params_text: "Click 'Edit Parameters' to get started.",
                no_options_title: "No Options Found",
                no_options_text: "Click 'Add Option' to create your first scenario.",
            },
            ru: {
                edit_parameters: "Ред. параметры",
                export_json: "Экспорт JSON",
                import_json: "Импорт JSON",
                transpose_table: "Транспонировать",
                filter_options: "Фильтр по названию...",
                option_name: "Название опции",
                notes_price: "Заметки / Цена",
                actions: "Действия",
                add_option: "Добавить опцию",
                parameter_editor: "Редактор параметров",
                add_parameter: "Добавить параметр",
                save_and_close: "Сохранить и закрыть",
                delete: "Удалить",
                clone: "Клонировать",
                score: "Оценка",
                color: "Цвет",
                description: "Описание",
                parameter_name: "Название параметра",
                parameter: "Параметр",
                new_option_name: "Новая опция",
                new_option_notes: "Заметки...",
                new_parameter_name: "Новый параметр",
                default_palette_desc: "Описание для оценки",
                import_success: "Данные успешно импортированы!",
                import_error: "Не удалось прочитать или обработать JSON файл.",
                changes_saved: "Изменения сохранены автоматически.", // Это сообщение больше не отображается, но оставлено для полноты i18n
                no_params_title: "Параметры не найдены",
                no_params_text: "Нажмите 'Ред. параметры', чтобы начать.",
                no_options_title: "Опции не найдены",
                no_options_text: "Нажмите 'Добавить опцию', чтобы создать первый сценарий.",
            }
        };

        const getLangString = (key) => i18n[state.lang][key] || key;
        
        const updateUIText = () => {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (i18n[state.lang] && i18n[state.lang][key]) {
                    el.textContent = i18n[state.lang][key];
                }
            });
             document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (i18n[state.lang] && i18n[state.lang][key]) {
                    el.placeholder = i18n[state.lang][key];
                }
            });
            renderTable();
        };
        
        // --- Utility Functions ---

        // NEW: Убрано навязчивое уведомление. Теперь оно показывается только для важных событий (например, импорт).
        const showToast = (messageKey) => {
            const toast = document.getElementById('toast');
            toast.textContent = getLangString(messageKey);
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        };

        // NEW: Эта функция сохраняет все текущие данные (параметры и опции) в localStorage браузера.
        const saveState = () => { 
            try { 
                localStorage.setItem('gemini.parameters', JSON.stringify(state.parameters)); 
                localStorage.setItem('gemini.options', JSON.stringify(state.options)); 
            } catch (e) { 
                console.error("Error saving to localStorage:", e); 
            } 
        };

        // NEW: Эта функция загружает данные из localStorage при запуске приложения.
        // Если сохраненных данных нет, она использует начальные данные.
        const loadState = async () => {
            const savedLang = localStorage.getItem('gemini.lang'); 
            if (savedLang) state.lang = savedLang;

            const savedParams = localStorage.getItem('gemini.parameters'); 
            const savedOptions = localStorage.getItem('gemini.options');

            if (savedParams && savedOptions) { 
                state.parameters = JSON.parse(savedParams); 
                state.options = JSON.parse(savedOptions); 
            } else { 
                const d = getInitialData(); 
                state.parameters = d.parameters; 
                state.options = d.options; 
            }
            state.parameters.sort((a, b) => a.order - b.order); 
            rebuildMappings(); 
            updateUIText();
        };

        const rebuildMappings = () => {
            state.colorMap.clear(); state.descriptionMap.clear(); const descKey = `description_${state.lang}`;
            for (const param of state.parameters) {
                const paramColorMap = new Map(); const paramDescMap = new Map(); const sortedPalette = [...param.palette].sort((a,b) => b.score - a.score);
                for (const p of sortedPalette) { paramColorMap.set(p.score, p.colour); const d = p[descKey] || p.description_en; if(d) { paramDescMap.set(p.score, d); } }
                state.colorMap.set(param.id, paramColorMap); state.descriptionMap.set(param.id, paramDescMap);
            }
        };

        function getDescriptionForScore(paramId, score) {
            if (score === null || score === undefined || score === '') return ''; const numericScore = Number(score);
            const paramDescMap = state.descriptionMap.get(paramId); if (!paramDescMap) return String(score); if (paramDescMap.has(numericScore)) { return paramDescMap.get(numericScore); }
            let prevDesc = null; let nextDesc = null;
            for (let i = numericScore - 1; i >= 1; i--) { if (paramDescMap.has(i)) { prevDesc = paramDescMap.get(i); break; } }
            for (let i = numericScore + 1; i <= 10; i++) { if (paramDescMap.has(i)) { nextDesc = paramDescMap.get(i); break; } }
            if (prevDesc && nextDesc) return `> ${prevDesc}, < ${nextDesc}`; if (prevDesc) return `> ${prevDesc}`; if (nextDesc) return `< ${nextDesc}`; return String(score);
        }

        function calculateAverageScore(option) {
            const scores = Object.values(option.scores).filter(score => score !== '' && score !== null && score !== undefined);
            if (scores.length === 0) return null;
            const sum = scores.reduce((acc, score) => acc + Number(score), 0);
            return Math.round(sum / scores.length);
        }

        function getColorForAverageScore(averageScore) {
            if (averageScore === null || state.parameters.length === 0) return '#FFFFFF';
            const firstParam = state.parameters[0];
            const colorMap = state.colorMap.get(firstParam.id);
            if (!colorMap) return '#FFFFFF';
            return colorMap.get(averageScore) || '#FFFFFF';
        }

        // --- RENDERING LOGIC (Unchanged) ---

        function renderTable() {
            const table = document.getElementById('main-table');
            const header = document.getElementById('table-header');
            const body = document.getElementById('table-body');
            
            table.className = `w-full text-left ${state.isTransposed ? 'transposed-table' : 'standard-table'}`;

            if (state.isTransposed) {
                renderTransposedHeader(header);
                renderTransposedBody(body);
            } else {
                renderStandardHeader(header);
                renderStandardBody(body);
            }
            if (state.parameters.length === 0) {
                 body.innerHTML = `<tr><td colspan="3" class="text-center p-12"><div class="flex flex-col items-center space-y-4"><i data-lucide="settings" class="ai-icon w-16 h-16 text-gray-500"></i><h3 class="text-xl font-bold text-gray-300">${getLangString('no_params_title')}</h3><p class="text-gray-400">${getLangString('no_params_text')}</p></div></td></tr>`;
                 lucide.createIcons();
            }
        }

        function renderStandardHeader(header) {
            const nameKey = `name_${state.lang}`;
            let headerHTML = '<tr>';
            headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left sticky-col-header gradient-text">${getLangString('option_name')}</th>`;
            headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left gradient-text">${getLangString('notes_price')}</th>`;
            state.parameters.forEach(param => {
                headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left gradient-text">${param[nameKey] || param.name_en}</th>`;
            });
            headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-center gradient-text">${getLangString('actions')}</th>`;
            headerHTML += '</tr>';
            header.innerHTML = headerHTML;
        }

        function renderStandardBody(body) {
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));

            if (state.parameters.length > 0 && filteredOptions.length === 0) {
                 body.innerHTML = `<tr><td colspan="${state.parameters.length + 3}" class="text-center p-12"><div class="flex flex-col items-center space-y-4"><i data-lucide="database" class="ai-icon w-16 h-16 text-gray-500"></i><h3 class="text-xl font-bold text-gray-300">${getLangString('no_options_title')}</h3><p class="text-gray-400">${getLangString('no_options_text')}</p></div></td></tr>`;
                 lucide.createIcons();
                 return;
            }

            let bodyHTML = '';
            filteredOptions.forEach((option, optionIndex) => {
                const actualIndex = state.options.findIndex(o => o.id === option.id);
                const averageScore = calculateAverageScore(option);
                const rowColor = getColorForAverageScore(averageScore);
                bodyHTML += `<tr class="hover:bg-opacity-80 border-b border-gray-700 transition-all duration-200" data-option-id="${option.id}" style="background-color: ${rowColor};">`;
                bodyHTML += `<td class="p-4 text-sm font-medium sticky-col" contenteditable="true" data-field="title" style="background-color: ${rowColor};">${option.title}</td>`;
                bodyHTML += `<td class="p-4 text-sm text-gray-300" contenteditable="true" data-field="price" style="background-color: ${rowColor};">${option.price}</td>`;
                state.parameters.forEach((param, paramIndex) => {
                    const score = option.scores[param.id] || '';
                    const color = state.colorMap.get(param.id)?.get(Number(score)) || 'rgba(26, 26, 46, 0.6)';
                    const textColor = getContrastTextColor(color);
                    const displayText = getDescriptionForScore(param.id, score);
                    bodyHTML += `
                        <td class="p-0 text-center score-cell transition-all duration-200" style="background-color: ${color}; color: ${textColor};" 
                            data-option-id="${option.id}" data-param-id="${param.id}" 
                            data-option-index="${optionIndex}" data-param-index="${paramIndex}">
                            <span class="score-text p-4 block cursor-pointer text-xs h-full hover:bg-black hover:bg-opacity-20" style="color: ${textColor};">${displayText}</span>
                            <input type="number" min="1" max="10" value="${score}" class="score-input w-full h-full p-4 bg-transparent text-center font-semibold focus:outline-none focus:ring-2 focus:ring-purple-500" style="color: ${textColor};">
                        </td>`;
                });
                bodyHTML += `<td class="p-4 text-center" style="background-color: ${rowColor};">
                    <div class="flex items-center justify-center space-x-2">
                        <button class="text-gray-400 hover:text-purple-400 move-up-btn transition-colors" data-option-id="${option.id}" title="Переместить вверх" ${actualIndex === 0 ? 'disabled' : ''}>
                            <i data-lucide="arrow-up" class="ai-icon w-4 h-4"></i>
                        </button>
                        <button class="text-gray-400 hover:text-purple-400 move-down-btn transition-colors" data-option-id="${option.id}" title="Переместить вниз" ${actualIndex === state.options.length - 1 ? 'disabled' : ''}>
                            <i data-lucide="arrow-down" class="ai-icon w-4 h-4"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 clone-option-btn transition-colors" data-option-id="${option.id}" title="Клонировать">
                            <i data-lucide="copy" class="ai-icon w-4 h-4"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300 delete-option-btn transition-colors" data-option-id="${option.id}" title="Удалить">
                            <i data-lucide="trash-2" class="ai-icon w-4 h-4"></i>
                        </button>
                    </div>
                </td>`;
                bodyHTML += '</tr>';
            });
            body.innerHTML = bodyHTML;
            lucide.createIcons();
        }

        function renderTransposedHeader(header) {
            let headerHTML = '<tr>';
            headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left sticky-col-header gradient-text">${getLangString('parameter')}</th>`;
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));

            filteredOptions.forEach(option => {
                headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left gradient-text">${option.title}</th>`;
            });
            headerHTML += '</tr>';
            header.innerHTML = headerHTML;
        }

        function renderTransposedBody(body) {
            const nameKey = `name_${state.lang}`;
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));
            
            if (state.parameters.length > 0 && filteredOptions.length === 0) {
                 body.innerHTML = `<tr><td colspan="${state.parameters.length + 1}" class="text-center p-12"><div class="flex flex-col items-center space-y-4"><i data-lucide="database" class="ai-icon w-16 h-16 text-gray-500"></i><h3 class="text-xl font-bold text-gray-300">${getLangString('no_options_title')}</h3><p class="text-gray-400">${getLangString('no_options_text')}</p></div></td></tr>`;
                 lucide.createIcons();
                 return;
            }

            let bodyHTML = '';
            state.parameters.forEach((param, paramIndex) => {
                bodyHTML += `<tr class="hover:bg-opacity-80 border-b border-gray-700 transition-all duration-200" data-param-id="${param.id}">`;
                bodyHTML += `<td class="p-4 text-sm font-medium sticky-col">${param[nameKey] || param.name_en}</td>`;
                filteredOptions.forEach((option, optionIndex) => {
                    const score = option.scores[param.id] || '';
                    const color = state.colorMap.get(param.id)?.get(Number(score)) || 'rgba(26, 26, 46, 0.6)';
                    const textColor = getContrastTextColor(color);
                    const displayText = getDescriptionForScore(param.id, score);
                    bodyHTML += `
                        <td class="p-0 text-center score-cell transition-all duration-200" style="background-color: ${color}; color: ${textColor};" 
                            data-option-id="${option.id}" data-param-id="${param.id}" 
                            data-option-index="${optionIndex}" data-param-index="${paramIndex}">
                            <span class="score-text p-4 block cursor-pointer text-xs h-full hover:bg-black hover:bg-opacity-20" style="color: ${textColor};">${displayText}</span>
                            <input type="number" min="1" max="10" value="${score}" class="score-input w-full h-full p-4 bg-transparent text-center font-semibold focus:outline-none focus:ring-2 focus:ring-purple-500" style="color: ${textColor};">
                        </td>`;
                });
                bodyHTML += `</tr>`;
            });
            body.innerHTML = bodyHTML;
            lucide.createIcons();
        }

        const renderParamEditor = () => {
            const paramList = document.getElementById('param-list'); paramList.innerHTML = '';
            const nameKey = `name_${state.lang}`; const descKey = `description_${state.lang}`;
            state.parameters.forEach((param, paramIndex) => {
                const paramDiv = document.createElement('div'); 
                paramDiv.className = 'p-6 border border-gray-600 rounded-2xl glass-morphism'; 
                paramDiv.dataset.paramId = param.id;
                let paletteHTML = ''; const sortedPalette = [...param.palette].sort((a, b) => b.score - a.score);
                sortedPalette.forEach(p => { 
                    paletteHTML += `<div class="grid grid-cols-12 gap-3 items-center mb-3">
                        <span class="col-span-1 text-center font-bold text-purple-400 text-lg">${p.score}</span>
                        <div class="col-span-2">
                            <input type="color" value="${p.colour}" data-score="${p.score}" data-field="colour" class="w-full h-10 border-2 border-gray-600 rounded-lg cursor-pointer bg-transparent">
                        </div>
                        <div class="col-span-9">
                            <input type="text" value="${p[descKey] || p.description_en || ''}" data-score="${p.score}" data-field="description" class="modern-input w-full text-sm">
                        </div>
                    </div>`; 
                });
                paramDiv.innerHTML = `<div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <button class="text-gray-400 hover:text-purple-400 move-param-up-btn transition-colors" data-param-id="${param.id}" title="Переместить вверх" ${paramIndex === 0 ? 'disabled' : ''}>
                            <i data-lucide="arrow-up" class="ai-icon"></i>
                        </button>
                        <button class="text-gray-400 hover:text-purple-400 move-param-down-btn transition-colors" data-param-id="${param.id}" title="Переместить вниз" ${paramIndex === state.parameters.length - 1 ? 'disabled' : ''}>
                            <i data-lucide="arrow-down" class="ai-icon"></i>
                        </button>
                    </div>
                    <input type="text" value="${param[nameKey] || param.name_en}" data-field="name" class="text-xl font-bold bg-transparent border-b-2 border-transparent focus:border-purple-500 focus:outline-none flex-1 mx-4 text-center gradient-text">
                    <button class="text-red-400 hover:text-red-300 delete-param-btn transition-colors" data-param-id="${param.id}" title="Удалить">
                        <i data-lucide="trash-2" class="ai-icon"></i>
                    </button>
                </div>
                <div class="grid grid-cols-12 gap-3 text-sm font-bold mb-4 text-gray-400">
                    <div class="col-span-1 text-center">${getLangString('score')}</div>
                    <div class="col-span-2">${getLangString('color')}</div>
                    <div class="col-span-9">${getLangString('description')}</div>
                </div>
                ${paletteHTML}`;
                paramList.appendChild(paramDiv);
            });
            lucide.createIcons();
        };

        // --- EVENT HANDLERS ---
        function handleTableInteraction(e) {
            const target = e.target; const optionId = target.closest('[data-option-id]')?.dataset.optionId;
            if (!optionId) return; const option = state.options.find(o => o.id === optionId); if (!option) return;
            if (target.isContentEditable) { target.addEventListener('blur', () => { const field = target.dataset.field; if (field === 'title' || field === 'price') { option[field] = target.textContent; saveState(); } }, { once: true }); }
            if (target.closest('.move-up-btn')) {
                const currentIndex = state.options.findIndex(o => o.id === optionId);
                if (currentIndex > 0) {
                    [state.options[currentIndex], state.options[currentIndex - 1]] = [state.options[currentIndex - 1], state.options[currentIndex]];
                    saveState();
                    renderTable();
                }
            }
            if (target.closest('.move-down-btn')) {
                const currentIndex = state.options.findIndex(o => o.id === optionId);
                if (currentIndex < state.options.length - 1) {
                    [state.options[currentIndex], state.options[currentIndex + 1]] = [state.options[currentIndex + 1], state.options[currentIndex]];
                    saveState();
                    renderTable();
                }
            }
            if (target.closest('.clone-option-btn')) { 
                const newId = `option_${Date.now()}`; 
                const clonedOption = { 
                    id: newId, 
                    title: option.title + ' (копия)', 
                    price: option.price, 
                    scores: { ...option.scores } 
                }; 
                const currentIndex = state.options.findIndex(o => o.id === optionId);
                state.options.splice(currentIndex + 1, 0, clonedOption);
                saveState(); 
                renderTable(); 
            }
            if (target.closest('.delete-option-btn')) { state.options = state.options.filter(o => o.id !== optionId); saveState(); renderTable(); }
            const scoreCell = target.closest('.score-cell'); if (scoreCell && !scoreCell.classList.contains('editing')) { scoreCell.classList.add('editing'); const input = scoreCell.querySelector('.score-input'); input.focus(); input.select(); }
        }
        
        function handleScoreInput(e) {
            const input = e.target; if (!input.matches('.score-input')) return; const scoreCell = input.closest('.score-cell'); const { optionId, paramId } = scoreCell.dataset; const option = state.options.find(o => o.id === optionId);
            if (option) { 
                let value = parseInt(input.value, 10); 
                if (isNaN(value)) value = ''; 
                else if (value < 1) value = 1; 
                else if (value > 10) value = 10; 
                input.value = value; 
                option.scores[paramId] = value; 
                const newColor = state.colorMap.get(paramId)?.get(value) || 'rgba(26, 26, 46, 0.6)';
                const textColor = getContrastTextColor(newColor);
                scoreCell.style.backgroundColor = newColor;
                scoreCell.style.color = textColor;
                input.style.color = textColor;
                const scoreText = scoreCell.querySelector('.score-text');
                if (scoreText) scoreText.style.color = textColor;
                saveState(); 
            }
        }

        function handleScoreBlur(e) {
            const input = e.target; if (!input.matches('.score-input')) return; const scoreCell = input.closest('.score-cell');
            if (scoreCell) { const displayText = getDescriptionForScore(scoreCell.dataset.paramId, input.value); scoreCell.querySelector('.score-text').textContent = displayText; scoreCell.classList.remove('editing'); }
        }
        
        function handleTableKeyDown(e) {
            if (!e.target.matches('.score-input')) return;
            const scoreCell = e.target.closest('.score-cell');
            let { optionIndex, paramIndex } = scoreCell.dataset;
            optionIndex = parseInt(optionIndex);
            paramIndex = parseInt(paramIndex);
            let nextElement = null;
            const move = (d_opt, d_par) => document.querySelector(`[data-option-index="${optionIndex + d_opt}"][data-param-index="${paramIndex + d_par}"]`);
            switch (e.key) {
                case 'ArrowUp': nextElement = state.isTransposed ? move(0, -1) : move(0, -1); break;
                case 'ArrowDown': case 'Enter': nextElement = state.isTransposed ? move(0, 1) : move(0, 1); break;
                case 'ArrowLeft': nextElement = state.isTransposed ? move(-1, 0) : move(-1, 0); break;
                case 'ArrowRight': nextElement = state.isTransposed ? move(1, 0) : move(1, 0); break;
                case 'Escape': e.target.blur(); break;
            }
            if (nextElement) {
                e.preventDefault();
                nextElement.classList.add('editing'); const nextInput = nextElement.querySelector('.score-input'); nextInput.focus(); nextInput.select();
            }
        }
        
        // --- Button Listeners (updates highlighted) ---
        document.getElementById('transpose-btn').addEventListener('click', () => {
            state.isTransposed = !state.isTransposed;
            renderTable();
        });
        document.getElementById('edit-params-btn').addEventListener('click', () => { renderParamEditor(); document.getElementById('param-editor-modal').classList.remove('hidden'); });
        document.getElementById('close-modal-btn').addEventListener('click', () => { document.getElementById('param-editor-modal').classList.add('hidden'); });
        
        // NEW: "Save" button in modal now saves state and redraws table
        document.getElementById('save-params-btn').addEventListener('click', () => { 
            // Sort parameters by order before saving
            state.parameters.sort((a, b) => a.order - b.order); 
            rebuildMappings(); 
            saveState(); 
            renderTable(); 
            document.getElementById('param-editor-modal').classList.add('hidden'); 
        });
        
        document.getElementById('add-param-btn').addEventListener('click', () => {
            const newId = `param_${Date.now()}`; const newOrder = state.parameters.length > 0 ? Math.max(...state.parameters.map(p => p.order)) + 1 : 1;
            const defaultColors = ["#00C853", "#1BCB3F", "#64DD17", "#C6FF00", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#F44336", "#D50000"];
            const newParam = { id: newId, order: newOrder, name_ru: getLangString('new_parameter_name'), name_en: getLangString('new_parameter_name'), palette: Array.from({ length: 10 }, (_, i) => ({ score: 10 - i, colour: defaultColors[i], description_en: ``, description_ru: `` })) };
            state.parameters.push(newParam); renderParamEditor();
        });
        
        // NEW: Adding an option now saves the state immediately
        document.getElementById('add-option-btn').addEventListener('click', () => {
            const newId = `option_${Date.now()}`; const newOption = { id: newId, title: getLangString('new_option_name'), price: getLangString('new_option_notes'), scores: {} };
            state.options.push(newOption); saveState(); renderTable();
        });
        
        const tableBody = document.getElementById('table-body');
        tableBody.addEventListener('click', handleTableInteraction);
        tableBody.addEventListener('input', handleScoreInput);
        tableBody.addEventListener('focusout', handleScoreBlur);
        tableBody.addEventListener('keydown', handleTableKeyDown);

        document.getElementById('search-box').addEventListener('input', () => renderTable());
        
        document.getElementById('param-list').addEventListener('input', (e) => {
             const t = e.target; const pDiv = t.closest('[data-param-id]'); if (!pDiv) return; const pId = pDiv.dataset.paramId; const p = state.parameters.find(p => p.id === pId); if (!p) return; const f = t.dataset.field;
             if (f === 'name') { p[`name_${state.lang}`] = t.value; } else if(f === 'colour' || f === 'description') { const s = parseInt(t.dataset.score, 10); const pItem = p.palette.find(p => p.score === s); if(pItem) { if(f === 'colour') pItem.colour = t.value; else pItem[`description_${state.lang}`] = t.value; } }
             rebuildMappings();
        });
        
        document.getElementById('param-list').addEventListener('click', (e) => {
            if(e.target.closest('.move-param-up-btn')) {
                const paramId = e.target.closest('.move-param-up-btn').dataset.paramId;
                const currentIndex = state.parameters.findIndex(p => p.id === paramId);
                if (currentIndex > 0) {
                    // Swap with previous parameter
                    [state.parameters[currentIndex], state.parameters[currentIndex - 1]] = [state.parameters[currentIndex - 1], state.parameters[currentIndex]];
                    // Update order values
                    state.parameters[currentIndex - 1].order = currentIndex;
                    state.parameters[currentIndex].order = currentIndex + 1;
                    rebuildMappings();
                    renderParamEditor();
                }
            }
            if(e.target.closest('.move-param-down-btn')) {
                const paramId = e.target.closest('.move-param-down-btn').dataset.paramId;
                const currentIndex = state.parameters.findIndex(p => p.id === paramId);
                if (currentIndex < state.parameters.length - 1) {
                    // Swap with next parameter
                    [state.parameters[currentIndex], state.parameters[currentIndex + 1]] = [state.parameters[currentIndex + 1], state.parameters[currentIndex]];
                    // Update order values
                    state.parameters[currentIndex].order = currentIndex + 1;
                    state.parameters[currentIndex + 1].order = currentIndex + 2;
                    rebuildMappings();
                    renderParamEditor();
                }
            }
            if(e.target.closest('.delete-param-btn')) { 
                const pId = e.target.closest('.delete-param-btn').dataset.paramId; 
                state.parameters = state.parameters.filter(p => p.id !== pId); 
                state.options.forEach(opt => delete opt.scores[pId]); 
                // Update order values for remaining parameters
                state.parameters.forEach((p, index) => p.order = index + 1);
                renderParamEditor(); 
            }
        });
        
        document.getElementById('export-btn').addEventListener('click', () => {
            const dataToExport = { parameters: state.parameters, options: state.options }; const dataStr = JSON.stringify(dataToExport, null, 2); const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); const date = new Date().toISOString().slice(0, 10).replace(/-/g, ''); a.href = url; a.download = `gemini-data-${date}.json`; a.click(); URL.revokeObjectURL(url);
        });
        
        document.getElementById('import-file').addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.parameters && data.options) { state.parameters = data.parameters; state.options = data.options; state.parameters.sort((a, b) => a.order - b.order); saveState(); rebuildMappings(); updateUIText(); showToast('import_success'); } else { showToast('import_error'); }
                } catch (err) { console.error("Import error:", err); showToast('import_error'); }
            };
            reader.readAsText(file); event.target.value = '';
        });
        
        // --- INITIAL DATA (Unchanged) ---
        function getInitialData() {
            return {
                "parameters": [
                    {"id": "safety_global","order": 1,"name_ru": "Безопасность страны в мире","name_en": "Country safety globally","palette": [{"score": 10,"colour": "#00C853","description_ru": "Копибара","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Неуязвимый","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Выпендривается","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "Войну предсказывают","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "Война объявлена","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Война","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "safety_overall","order": 2,"name_ru": "Общая безопасность в стране","name_en": "Overall safety in country","palette": [{"score": 10,"colour": "#00C853","description_ru": "Рай","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Куча шпаны","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Полицейское государство","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "Картели","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Гражданская война","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "safety_personal","order": 3,"name_ru": "Моя безопасность в стране","name_en": "My safety in country","palette": [{"score": 10,"colour": "#00C853","description_ru": "Мы вас любим","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Вы уже как все","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "Интегрируйтесь","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Понаехали","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Вам будет неприятно","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "Гетто","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Мы вас изрежем","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "civil_status","order": 4,"name_ru": "Мой гражданский статус","name_en": "My civil status","palette": [{"score": 10,"colour": "#00C853","description_ru": "Гражданин по рождению","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Гражданин","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "ПМЖ","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "ВНЖ","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Цифровой кочевник","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Рабочая виза","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "3 месяца без визы","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "Беженец","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Нелегал","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "languages","order": 5,"name_ru": "Языки страны","name_en": "Country languages","palette": [{"score": 10,"colour": "#00C853","description_ru": "Русский + английский","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "Английский","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Национальный + английский 50%","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Национальный + английский 20%","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Национальный","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "cost_of_living","order": 6,"name_ru": "Уровень цен","name_en": "Cost of living","palette": [{"score": 10,"colour": "#00C853","description_ru": "Братислава","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Цюрих","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "housing","order": 7,"name_ru": "Жильё","name_en": "Housing","palette": [{"score": 10,"colour": "#00C853","description_ru": "Вилла в городе","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Дом-5 в городе","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "Квартира-5 в городе","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "Дом-5 за городом","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Квартира-4 на окраине","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Квартира-2 в центре","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "Квартира-2 на окраине","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "Студия в провинции","description_en": ""}]},
                    {"id": "climate","order": 8,"name_ru": "Климат","name_en": "Climate","palette": [{"score": 10,"colour": "#00C853","description_ru": "Вечная весна","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Мягкая зима","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Хорошее лето","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Невыносимое лето","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "Пустыня","description_en": ""}]},
                    {"id": "money_cushion","order": 9,"name_ru": "Размер финансовой подушки","name_en": "Financial cushion size","palette": [{"score": 10,"colour": "#00C853","description_ru": "10M €","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "1M €","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "5 лет трат","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "2 года трат","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "1 год трат","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "От зарплаты до зарплаты","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "Долги на годы","description_en": ""}]},
                    {"id": "monthly_expenses","order": 10,"name_ru": "Ежемесячные траты","name_en": "Monthly expenses","palette": [{"score": 10,"colour": "#00C853","description_ru": "10k €","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "5k €","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "Миска риса","description_en": ""}]}
                ],
                "options": []
            }
        }

        // --- INITIALIZATION ---
        // NEW: Load state from localStorage as soon as the page content is loaded.
        document.addEventListener('DOMContentLoaded', async () => {
            await loadState();
            lucide.createIcons(); // Initialize icons after content is loaded
        });

        // Function to determine if a color is light or dark and return appropriate text color
        function getContrastTextColor(color) {
            // Handle rgba colors
            if (color.startsWith('rgba')) {
                // For rgba colors with transparency, assume dark background
                return '#ffffff';
            }
            
            // Handle hex colors
            if (color.startsWith('#')) {
                const hex = color.replace('#', '');
                
                // Convert hex to RGB
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);
                
                // Calculate luminance using the relative luminance formula
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                
                // Return black text for light backgrounds, white text for dark backgrounds
                return luminance > 0.6 ? '#000000' : '#ffffff';
            }
            
            // Handle rgb colors
            if (color.startsWith('rgb')) {
                const matches = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (matches) {
                    const r = parseInt(matches[1]);
                    const g = parseInt(matches[2]);
                    const b = parseInt(matches[3]);
                    
                    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    return luminance > 0.6 ? '#000000' : '#ffffff';
                }
            }
            
            // Default to white text for unknown color formats
            return '#ffffff';
        }
    </script>
</body>
</html>
