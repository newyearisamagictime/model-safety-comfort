<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparative Life Parameters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --toast-bg: #333;
            --toast-text: #fff;
        }
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: #f3f4f6;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
        }
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #f9fafb;
        }
        /* Ensure sticky columns have a background in both standard and transposed views */
        .transposed-table .sticky-col, .standard-table .sticky-col {
             background-color: inherit !important;
        }
         .transposed-table tr:hover .sticky-col, .standard-table tr:hover .sticky-col {
             filter: brightness(0.95);
        }

        .sticky-col-header {
            position: sticky;
            left: 0;
            z-index: 15;
        }
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--toast-bg);
            color: var(--toast-text);
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Styles for showing text or input in a cell */
        .score-cell .score-input {
            display: none;
        }
        .score-cell.editing .score-text {
            display: none;
        }
        .score-cell.editing .score-input {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="flex flex-wrap justify-between items-center mb-6 gap-y-4">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700 w-full md:w-auto">Comparative Life Parameters</h1>
            <div class="flex items-center space-x-2 flex-wrap gap-2">
                <select id="language-switcher" class="bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <option value="en">English</option>
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                </select>
                 <button id="transpose-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-purple-700 transition-colors">
                    <span data-lang-key="transpose_table">Transpose</span>
                </button>
                <button id="edit-params-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-indigo-700 transition-colors">
                    <span data-lang-key="edit_parameters">Edit Parameters</span>
                </button>
                <button id="export-btn" class="bg-green-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-green-700 transition-colors">
                    <span data-lang-key="export_json">Export JSON</span>
                </button>
                <label for="import-file" class="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700 transition-colors cursor-pointer">
                    <span data-lang-key="import_json">Import JSON</span>
                    <input type="file" id="import-file" class="hidden" accept=".json">
                </label>
            </div>
        </header>

        <!-- Search / Filter -->
        <div class="mb-4">
            <input id="search-box" type="text" placeholder="Filter options..." data-lang-placeholder="filter_options" class="w-full md:w-1/3 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <!-- Main Table -->
        <div id="table-container" class="table-container bg-white shadow-lg rounded-lg">
            <table id="main-table" class="w-full text-left">
                <thead id="table-header">
                    <!-- Header will be dynamically generated -->
                </thead>
                <tbody id="table-body">
                    <!-- Body will be dynamically generated -->
                </tbody>
            </table>
        </div>
        <div class="mt-4">
            <button id="add-option-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md shadow hover:bg-blue-600 transition-colors">
                <span data-lang-key="add_option">Add Option</span>
            </button>
        </div>

    </div>

    <!-- Parameter Editor Modal -->
    <div id="param-editor-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-20">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" data-lang-key="parameter_editor">Parameter Editor</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="param-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <!-- Parameter items will be dynamically generated -->
            </div>
            <div class="mt-6 flex justify-between">
                <button id="add-param-btn" class="bg-green-500 text-white px-4 py-2 rounded-md shadow hover:bg-green-600">
                    <span data-lang-key="add_parameter">Add Parameter</span>
                </button>
                <button id="save-params-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow hover:bg-indigo-700">
                    <span data-lang-key="save_and_close">Save & Close</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast-notification"></div>

    <script type="module">
        // --- DATA AND STATE MANAGEMENT ---
        const state = {
            lang: 'ru', // Default to Russian
            isTransposed: false,
            parameters: [],
            options: [],
            colorMap: new Map(),
            descriptionMap: new Map(),
        };

        const i18n = {
            en: {
                edit_parameters: "Edit Parameters",
                export_json: "Export JSON",
                import_json: "Import JSON",
                transpose_table: "Transpose",
                filter_options: "Filter options by name...",
                option_name: "Option Name",
                notes_price: "Notes / Price",
                actions: "Actions",
                add_option: "Add Option",
                parameter_editor: "Parameter Editor",
                add_parameter: "Add Parameter",
                save_and_close: "Save & Close",
                delete: "Delete",
                clone: "Clone",
                score: "Score",
                color: "Color",
                description: "Description",
                parameter_name: "Parameter Name",
                parameter: "Parameter",
                new_option_name: "New Option",
                new_option_notes: "Notes...",
                new_parameter_name: "New Parameter",
                default_palette_desc: "Description for score",
                import_success: "Data imported successfully!",
                import_error: "Failed to read or parse JSON file.",
                changes_saved: "Changes saved automatically.", // This message is no longer shown, but kept for i18n
                no_params_title: "No Parameters Found",
                no_params_text: "Click 'Edit Parameters' to get started.",
                no_options_title: "No Options Found",
                no_options_text: "Click 'Add Option' to create your first scenario.",
            },
            ru: {
                edit_parameters: "–†–µ–¥. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã",
                export_json: "–≠–∫—Å–ø–æ—Ä—Ç JSON",
                import_json: "–ò–º–ø–æ—Ä—Ç JSON",
                transpose_table: "–¢—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞—Ç—å",
                filter_options: "–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...",
                option_name: "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏",
                notes_price: "–ó–∞–º–µ—Ç–∫–∏ / –¶–µ–Ω–∞",
                actions: "–î–µ–π—Å—Ç–≤–∏—è",
                add_option: "–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é",
                parameter_editor: "–†–µ–¥–∞–∫—Ç–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤",
                add_parameter: "–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä",
                save_and_close: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å",
                delete: "–£–¥–∞–ª–∏—Ç—å",
                clone: "–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å",
                score: "–û—Ü–µ–Ω–∫–∞",
                color: "–¶–≤–µ—Ç",
                description: "–û–ø–∏—Å–∞–Ω–∏–µ",
                parameter_name: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞",
                parameter: "–ü–∞—Ä–∞–º–µ—Ç—Ä",
                new_option_name: "–ù–æ–≤–∞—è –æ–ø—Ü–∏—è",
                new_option_notes: "–ó–∞–º–µ—Ç–∫–∏...",
                new_parameter_name: "–ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä",
                default_palette_desc: "–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –æ—Ü–µ–Ω–∫–∏",
                import_success: "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!",
                import_error: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å JSON —Ñ–∞–π–ª.",
                changes_saved: "–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", // –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã i18n
                no_params_title: "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
                no_params_text: "–ù–∞–∂–º–∏—Ç–µ '–†–µ–¥. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.",
                no_options_title: "–û–ø—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
                no_options_text: "–ù–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é', —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.",
            }
        };

        const getLangString = (key) => i18n[state.lang][key] || key;
        
        const updateUIText = () => {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (i18n[state.lang] && i18n[state.lang][key]) {
                    el.textContent = i18n[state.lang][key];
                }
            });
             document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (i18n[state.lang] && i18n[state.lang][key]) {
                    el.placeholder = i18n[state.lang][key];
                }
            });
            renderTable();
        };
        
        // --- Utility Functions ---

        // NEW: –£–±—Ä–∞–Ω–æ –Ω–∞–≤—è–∑—á–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –¢–µ–ø–µ—Ä—å –æ–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–º–ø–æ—Ä—Ç).
        const showToast = (messageKey) => {
            const toast = document.getElementById('toast');
            toast.textContent = getLangString(messageKey);
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        };

        // NEW: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –æ–ø—Ü–∏–∏) –≤ localStorage –±—Ä–∞—É–∑–µ—Ä–∞.
        const saveState = () => { 
            try { 
                localStorage.setItem('gemini.parameters', JSON.stringify(state.parameters)); 
                localStorage.setItem('gemini.options', JSON.stringify(state.options)); 
            } catch (e) { 
                console.error("Error saving to localStorage:", e); 
            } 
        };

        // NEW: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
        // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
        const loadState = async () => {
            const savedLang = localStorage.getItem('gemini.lang'); 
            if (savedLang) state.lang = savedLang;

            const savedParams = localStorage.getItem('gemini.parameters'); 
            const savedOptions = localStorage.getItem('gemini.options');

            if (savedParams && savedOptions) { 
                state.parameters = JSON.parse(savedParams); 
                state.options = JSON.parse(savedOptions); 
            } else { 
                const d = getInitialData(); 
                state.parameters = d.parameters; 
                state.options = d.options; 
            }
            state.parameters.sort((a, b) => a.order - b.order); 
            rebuildMappings(); 
            updateUIText();
        };

        const rebuildMappings = () => {
            state.colorMap.clear(); state.descriptionMap.clear(); const descKey = `description_${state.lang}`;
            for (const param of state.parameters) {
                const paramColorMap = new Map(); const paramDescMap = new Map(); const sortedPalette = [...param.palette].sort((a,b) => b.score - a.score);
                for (const p of sortedPalette) { paramColorMap.set(p.score, p.colour); const d = p[descKey] || p.description_en; if(d) { paramDescMap.set(p.score, d); } }
                state.colorMap.set(param.id, paramColorMap); state.descriptionMap.set(param.id, paramDescMap);
            }
        };

        function getDescriptionForScore(paramId, score) {
            if (score === null || score === undefined || score === '') return ''; const numericScore = Number(score);
            const paramDescMap = state.descriptionMap.get(paramId); if (!paramDescMap) return String(score); if (paramDescMap.has(numericScore)) { return paramDescMap.get(numericScore); }
            let prevDesc = null; let nextDesc = null;
            for (let i = numericScore - 1; i >= 1; i--) { if (paramDescMap.has(i)) { prevDesc = paramDescMap.get(i); break; } }
            for (let i = numericScore + 1; i <= 10; i++) { if (paramDescMap.has(i)) { nextDesc = paramDescMap.get(i); break; } }
            if (prevDesc && nextDesc) return `> ${prevDesc}, < ${nextDesc}`; if (prevDesc) return `> ${prevDesc}`; if (nextDesc) return `< ${nextDesc}`; return String(score);
        }

        function calculateAverageScore(option) {
            const scores = Object.values(option.scores).filter(score => score !== '' && score !== null && score !== undefined);
            if (scores.length === 0) return null;
            const sum = scores.reduce((acc, score) => acc + Number(score), 0);
            return Math.round(sum / scores.length);
        }

        function getColorForAverageScore(averageScore) {
            if (averageScore === null || state.parameters.length === 0) return '#FFFFFF';
            const firstParam = state.parameters[0];
            const colorMap = state.colorMap.get(firstParam.id);
            if (!colorMap) return '#FFFFFF';
            return colorMap.get(averageScore) || '#FFFFFF';
        }

        // --- RENDERING LOGIC (Unchanged) ---

        function renderTable() {
            const table = document.getElementById('main-table');
            const header = document.getElementById('table-header');
            const body = document.getElementById('table-body');
            
            table.className = `w-full text-left ${state.isTransposed ? 'transposed-table' : 'standard-table'}`;

            if (state.isTransposed) {
                renderTransposedHeader(header);
                renderTransposedBody(body);
            } else {
                renderStandardHeader(header);
                renderStandardBody(body);
            }
            if (state.parameters.length === 0) {
                 body.innerHTML = `<tr><td colspan="3" class="text-center p-8"><h3 class="text-lg font-bold">${getLangString('no_params_title')}</h3><p>${getLangString('no_params_text')}</p></td></tr>`;
            }
        }

        function renderStandardHeader(header) {
            const nameKey = `name_${state.lang}`;
            let headerHTML = '<tr>';
            headerHTML += `<th class="p-3 text-sm font-semibold tracking-wide text-left sticky-col-header bg-gray-200">${getLangString('option_name')}</th>`;
            headerHTML += `<th class="p-3 text-sm font-semibold tracking-wide text-left bg-gray-200">${getLangString('notes_price')}</th>`;
            state.parameters.forEach(param => {
                headerHTML += `<th class="p-3 text-sm font-semibold tracking-wide text-left bg-gray-200">${param[nameKey] || param.name_en}</th>`;
            });
            headerHTML += `<th class="p-3 text-sm font-semibold tracking-wide text-center bg-gray-200">${getLangString('actions')}</th>`;
            headerHTML += '</tr>';
            header.innerHTML = headerHTML;
        }

        function renderStandardBody(body) {
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));

            if (state.parameters.length > 0 && filteredOptions.length === 0) {
                 body.innerHTML = `<tr><td colspan="${state.parameters.length + 3}" class="text-center p-8"><h3 class="text-lg font-bold">${getLangString('no_options_title')}</h3><p>${getLangString('no_options_text')}</p></td></tr>`;
                 return;
            }

            let bodyHTML = '';
            filteredOptions.forEach((option, optionIndex) => {
                const averageScore = calculateAverageScore(option);
                const rowColor = getColorForAverageScore(averageScore);
                bodyHTML += `<tr class="hover:bg-gray-100 border-b border-gray-200" data-option-id="${option.id}" style="background-color: ${rowColor};">`;
                bodyHTML += `<td class="p-3 text-sm text-gray-700 font-medium sticky-col" contenteditable="true" data-field="title" style="background-color: ${rowColor};">${option.title}</td>`;
                bodyHTML += `<td class="p-3 text-sm text-gray-500" contenteditable="true" data-field="price" style="background-color: ${rowColor};">${option.price}</td>`;
                state.parameters.forEach((param, paramIndex) => {
                    const score = option.scores[param.id] || '';
                    const color = state.colorMap.get(param.id)?.get(Number(score)) || '#FFFFFF';
                    const displayText = getDescriptionForScore(param.id, score);
                    bodyHTML += `
                        <td class="p-0 text-center score-cell" style="background-color: ${color};" 
                            data-option-id="${option.id}" data-param-id="${param.id}" 
                            data-option-index="${optionIndex}" data-param-index="${paramIndex}">
                            <span class="score-text p-3 block cursor-pointer text-xs h-full">${displayText}</span>
                            <input type="number" min="1" max="10" value="${score}" class="score-input w-full h-full p-3 bg-transparent text-center font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                        </td>`;
                });
                bodyHTML += `<td class="p-3 text-center" style="background-color: ${rowColor};">
                    <button class="text-blue-500 hover:text-blue-700 clone-option-btn mr-2" data-option-id="${option.id}" title="–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
                    <button class="text-red-500 hover:text-red-700 delete-option-btn" data-option-id="${option.id}">${getLangString('delete')}</button>
                </td>`;
                bodyHTML += '</tr>';
            });
            body.innerHTML = bodyHTML;
        }

        function renderTransposedHeader(header) {
            let headerHTML = '<tr>';
            headerHTML += `<th class="p-3 text-sm font-semibold tracking-wide text-left sticky-col-header bg-gray-200">${getLangString('parameter')}</th>`;
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));

            filteredOptions.forEach(option => {
                headerHTML += `<th class="p-3 text-sm font-semibold tracking-wide text-left bg-gray-200">${option.title}</th>`;
            });
            headerHTML += '</tr>';
            header.innerHTML = headerHTML;
        }

        function renderTransposedBody(body) {
            const nameKey = `name_${state.lang}`;
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));
            
            if (state.parameters.length > 0 && filteredOptions.length === 0) {
                 body.innerHTML = `<tr><td colspan="${state.parameters.length + 1}" class="text-center p-8"><h3 class="text-lg font-bold">${getLangString('no_options_title')}</h3><p>${getLangString('no_options_text')}</p></td></tr>`;
                 return;
            }

            let bodyHTML = '';
            state.parameters.forEach((param, paramIndex) => {
                bodyHTML += `<tr class="bg-white hover:bg-gray-100 border-b border-gray-200" data-param-id="${param.id}">`;
                bodyHTML += `<td class="p-3 text-sm text-gray-700 font-medium sticky-col">${param[nameKey] || param.name_en}</td>`;
                filteredOptions.forEach((option, optionIndex) => {
                    const score = option.scores[param.id] || '';
                    const color = state.colorMap.get(param.id)?.get(Number(score)) || '#FFFFFF';
                    const displayText = getDescriptionForScore(param.id, score);
                    bodyHTML += `
                        <td class="p-0 text-center score-cell" style="background-color: ${color};" 
                            data-option-id="${option.id}" data-param-id="${param.id}" 
                            data-option-index="${optionIndex}" data-param-index="${paramIndex}">
                            <span class="score-text p-3 block cursor-pointer text-xs h-full">${displayText}</span>
                            <input type="number" min="1" max="10" value="${score}" class="score-input w-full h-full p-3 bg-transparent text-center font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white">
                        </td>`;
                });
                bodyHTML += `</tr>`;
            });
            body.innerHTML = bodyHTML;
        }

        const renderParamEditor = () => {
            const paramList = document.getElementById('param-list'); paramList.innerHTML = '';
            const nameKey = `name_${state.lang}`; const descKey = `description_${state.lang}`;
            state.parameters.forEach((param) => {
                const paramDiv = document.createElement('div'); paramDiv.className = 'p-4 border rounded-lg bg-gray-50'; paramDiv.dataset.paramId = param.id;
                let paletteHTML = ''; const sortedPalette = [...param.palette].sort((a, b) => b.score - a.score);
                sortedPalette.forEach(p => { paletteHTML += `<div class="grid grid-cols-12 gap-2 items-center mb-1"><span class="col-span-1 text-center font-medium">${p.score}</span><div class="col-span-2"><input type="color" value="${p.colour}" data-score="${p.score}" data-field="colour" class="w-full h-8 border-none rounded cursor-pointer"></div><div class="col-span-9"><input type="text" value="${p[descKey] || p.description_en || ''}" data-score="${p.score}" data-field="description" class="w-full p-1 border border-gray-300 rounded-md text-sm"></div></div>`; });
                paramDiv.innerHTML = `<div class="flex justify-between items-center mb-3"><input type="text" value="${param[nameKey] || param.name_en}" data-field="name" class="text-lg font-semibold border-b-2 border-transparent focus:border-indigo-500 focus:outline-none w-full"><button class="text-red-500 hover:text-red-700 ml-4 delete-param-btn" data-param-id="${param.id}">${getLangString('delete')}</button></div><div class="grid grid-cols-12 gap-2 text-sm font-semibold mb-2"><div class="col-span-1 text-center">${getLangString('score')}</div><div class="col-span-2">${getLangString('color')}</div><div class="col-span-9">${getLangString('description')}</div></div>${paletteHTML}`;
                paramList.appendChild(paramDiv);
            });
        };

        // --- EVENT HANDLERS ---
        function handleTableInteraction(e) {
            const target = e.target; const optionId = target.closest('[data-option-id]')?.dataset.optionId;
            if (!optionId) return; const option = state.options.find(o => o.id === optionId); if (!option) return;
            if (target.isContentEditable) { target.addEventListener('blur', () => { const field = target.dataset.field; if (field === 'title' || field === 'price') { option[field] = target.textContent; saveState(); } }, { once: true }); }
            if (target.closest('.clone-option-btn')) { 
                const newId = `option_${Date.now()}`; 
                const clonedOption = { 
                    id: newId, 
                    title: option.title + ' (–∫–æ–ø–∏—è)', 
                    price: option.price, 
                    scores: { ...option.scores } 
                }; 
                const currentIndex = state.options.findIndex(o => o.id === optionId);
                state.options.splice(currentIndex + 1, 0, clonedOption);
                saveState(); 
                renderTable(); 
            }
            if (target.closest('.delete-option-btn')) { state.options = state.options.filter(o => o.id !== optionId); saveState(); renderTable(); }
            const scoreCell = target.closest('.score-cell'); if (scoreCell && !scoreCell.classList.contains('editing')) { scoreCell.classList.add('editing'); const input = scoreCell.querySelector('.score-input'); input.focus(); input.select(); }
        }
        
        function handleScoreInput(e) {
            const input = e.target; if (!input.matches('.score-input')) return; const scoreCell = input.closest('.score-cell'); const { optionId, paramId } = scoreCell.dataset; const option = state.options.find(o => o.id === optionId);
            if (option) { let value = parseInt(input.value, 10); if (isNaN(value)) value = ''; else if (value < 1) value = 1; else if (value > 10) value = 10; input.value = value; option.scores[paramId] = value; scoreCell.style.backgroundColor = state.colorMap.get(paramId)?.get(value) || '#FFFFFF'; saveState(); }
        }

        function handleScoreBlur(e) {
            const input = e.target; if (!input.matches('.score-input')) return; const scoreCell = input.closest('.score-cell');
            if (scoreCell) { const displayText = getDescriptionForScore(scoreCell.dataset.paramId, input.value); scoreCell.querySelector('.score-text').textContent = displayText; scoreCell.classList.remove('editing'); }
        }
        
        function handleTableKeyDown(e) {
            if (!e.target.matches('.score-input')) return;
            const scoreCell = e.target.closest('.score-cell');
            let { optionIndex, paramIndex } = scoreCell.dataset;
            optionIndex = parseInt(optionIndex);
            paramIndex = parseInt(paramIndex);
            let nextElement = null;
            const move = (d_opt, d_par) => document.querySelector(`[data-option-index="${optionIndex + d_opt}"][data-param-index="${paramIndex + d_par}"]`);
            switch (e.key) {
                case 'ArrowUp': nextElement = state.isTransposed ? move(0, -1) : move(0, -1); break;
                case 'ArrowDown': case 'Enter': nextElement = state.isTransposed ? move(0, 1) : move(0, 1); break;
                case 'ArrowLeft': nextElement = state.isTransposed ? move(-1, 0) : move(-1, 0); break;
                case 'ArrowRight': nextElement = state.isTransposed ? move(1, 0) : move(1, 0); break;
                case 'Escape': e.target.blur(); break;
            }
            if (nextElement) {
                e.preventDefault();
                nextElement.classList.add('editing'); const nextInput = nextElement.querySelector('.score-input'); nextInput.focus(); nextInput.select();
            }
        }
        
        // --- Button Listeners (updates highlighted) ---
        document.getElementById('transpose-btn').addEventListener('click', () => {
            state.isTransposed = !state.isTransposed;
            renderTable();
        });
        document.getElementById('edit-params-btn').addEventListener('click', () => { renderParamEditor(); document.getElementById('param-editor-modal').classList.remove('hidden'); });
        document.getElementById('close-modal-btn').addEventListener('click', () => { document.getElementById('param-editor-modal').classList.add('hidden'); });
        
        // NEW: "Save" button in modal now saves state and redraws table
        document.getElementById('save-params-btn').addEventListener('click', () => { saveState(); renderTable(); document.getElementById('param-editor-modal').classList.add('hidden'); });
        
        document.getElementById('add-param-btn').addEventListener('click', () => {
            const newId = `param_${Date.now()}`; const newOrder = state.parameters.length > 0 ? Math.max(...state.parameters.map(p => p.order)) + 1 : 1;
            const defaultColors = ["#00C853", "#1BCB3F", "#64DD17", "#C6FF00", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#F44336", "#D50000"];
            const newParam = { id: newId, order: newOrder, name_ru: getLangString('new_parameter_name'), name_en: getLangString('new_parameter_name'), palette: Array.from({ length: 10 }, (_, i) => ({ score: 10 - i, colour: defaultColors[i], description_en: ``, description_ru: `` })) };
            state.parameters.push(newParam); renderParamEditor();
        });
        
        // NEW: Adding an option now saves the state immediately
        document.getElementById('add-option-btn').addEventListener('click', () => {
            const newId = `option_${Date.now()}`; const newOption = { id: newId, title: getLangString('new_option_name'), price: getLangString('new_option_notes'), scores: {} };
            state.options.push(newOption); saveState(); renderTable();
        });
        
        const tableBody = document.getElementById('table-body');
        tableBody.addEventListener('click', handleTableInteraction);
        tableBody.addEventListener('input', handleScoreInput);
        tableBody.addEventListener('focusout', handleScoreBlur);
        tableBody.addEventListener('keydown', handleTableKeyDown);

        document.getElementById('search-box').addEventListener('input', () => renderTable());
        
        document.getElementById('param-list').addEventListener('input', (e) => {
             const t = e.target; const pDiv = t.closest('[data-param-id]'); if (!pDiv) return; const pId = pDiv.dataset.paramId; const p = state.parameters.find(p => p.id === pId); if (!p) return; const f = t.dataset.field;
             if (f === 'name') { p[`name_${state.lang}`] = t.value; } else if(f === 'colour' || f === 'description') { const s = parseInt(t.dataset.score, 10); const pItem = p.palette.find(p => p.score === s); if(pItem) { if(f === 'colour') pItem.colour = t.value; else pItem[`description_${state.lang}`] = t.value; } }
             rebuildMappings();
        });
        
        document.getElementById('param-list').addEventListener('click', (e) => {
            if(e.target.closest('.delete-param-btn')) { const pId = e.target.closest('.delete-param-btn').dataset.paramId; state.parameters = state.parameters.filter(p => p.id !== pId); state.options.forEach(opt => delete opt.scores[pId]); renderParamEditor(); }
        });
        
        document.getElementById('export-btn').addEventListener('click', () => {
            const dataToExport = { parameters: state.parameters, options: state.options }; const dataStr = JSON.stringify(dataToExport, null, 2); const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); const date = new Date().toISOString().slice(0, 10).replace(/-/g, ''); a.href = url; a.download = `gemini-data-${date}.json`; a.click(); URL.revokeObjectURL(url);
        });
        
        document.getElementById('import-file').addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.parameters && data.options) { state.parameters = data.parameters; state.options = data.options; state.parameters.sort((a, b) => a.order - b.order); saveState(); rebuildMappings(); updateUIText(); showToast('import_success'); } else { showToast('import_error'); }
                } catch (err) { console.error("Import error:", err); showToast('import_error'); }
            };
            reader.readAsText(file); event.target.value = '';
        });
        
        document.getElementById('language-switcher').addEventListener('change', (e) => { state.lang = e.target.value; localStorage.setItem('gemini.lang', state.lang); rebuildMappings(); updateUIText(); });

        // --- INITIAL DATA (Unchanged) ---
        function getInitialData() {
            return {
                "parameters": [
                    {"id": "safety_global","order": 1,"name_ru": "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω—ã –≤ –º–∏—Ä–µ","name_en": "Country safety globally","palette": [{"score": 10,"colour": "#00C853","description_ru": "–ö–æ–ø–∏–±–∞—Ä–∞","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "–ù–µ—É—è–∑–≤–∏–º—ã–π","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "–í—ã–ø–µ–Ω–¥—Ä–∏–≤–∞–µ—Ç—Å—è","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "–í–æ–π–Ω—É –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—é—Ç","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "–í–æ–π–Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∞","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "–í–æ–π–Ω–∞","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "safety_overall","order": 2,"name_ru": "–û–±—â–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ —Å—Ç—Ä–∞–Ω–µ","name_en": "Overall safety in country","palette": [{"score": 10,"colour": "#00C853","description_ru": "–†–∞–π","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "–ö—É—á–∞ —à–ø–∞–Ω—ã","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "–ü–æ–ª–∏—Ü–µ–π—Å–∫–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "–ö–∞—Ä—Ç–µ–ª–∏","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –≤–æ–π–Ω–∞","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "safety_personal","order": 3,"name_ru": "–ú–æ—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ —Å—Ç—Ä–∞–Ω–µ","name_en": "My safety in country","palette": [{"score": 10,"colour": "#00C853","description_ru": "–ú—ã –≤–∞—Å –ª—é–±–∏–º","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "–í—ã —É–∂–µ –∫–∞–∫ –≤—Å–µ","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ—Å—å","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "–ü–æ–Ω–∞–µ—Ö–∞–ª–∏","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "–í–∞–º –±—É–¥–µ—Ç –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "–ì–µ—Ç—Ç–æ","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "–ú—ã –≤–∞—Å –∏–∑—Ä–µ–∂–µ–º","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "civil_status","order": 4,"name_ru": "–ú–æ–π –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å","name_en": "My civil status","palette": [{"score": 10,"colour": "#00C853","description_ru": "–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω –ø–æ —Ä–æ–∂–¥–µ–Ω–∏—é","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "–ü–ú–ñ","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "–í–ù–ñ","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "–¶–∏—Ñ—Ä–æ–≤–æ–π –∫–æ—á–µ–≤–Ω–∏–∫","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "–†–∞–±–æ—á–∞—è –≤–∏–∑–∞","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "3 –º–µ—Å—è—Ü–∞ –±–µ–∑ –≤–∏–∑—ã","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "–ë–µ–∂–µ–Ω–µ—Ü","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "–ù–µ–ª–µ–≥–∞–ª","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "languages","order": 5,"name_ru": "–Ø–∑—ã–∫–∏ —Å—Ç—Ä–∞–Ω—ã","name_en": "Country languages","palette": [{"score": 10,"colour": "#00C853","description_ru": "–†—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π 50%","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–π 20%","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "cost_of_living","order": 6,"name_ru": "–£—Ä–æ–≤–µ–Ω—å —Ü–µ–Ω","name_en": "Cost of living","palette": [{"score": 10,"colour": "#00C853","description_ru": "–ë—Ä–∞—Ç–∏—Å–ª–∞–≤–∞","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "–¶—é—Ä–∏—Ö","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "housing","order": 7,"name_ru": "–ñ–∏–ª—å—ë","name_en": "Housing","palette": [{"score": 10,"colour": "#00C853","description_ru": "–í–∏–ª–ª–∞ –≤ –≥–æ—Ä–æ–¥–µ","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "–î–æ–º-5 –≤ –≥–æ—Ä–æ–¥–µ","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "–ö–≤–∞—Ä—Ç–∏—Ä–∞-5 –≤ –≥–æ—Ä–æ–¥–µ","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "–î–æ–º-5 –∑–∞ –≥–æ—Ä–æ–¥–æ–º","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "–ö–≤–∞—Ä—Ç–∏—Ä–∞-4 –Ω–∞ –æ–∫—Ä–∞–∏–Ω–µ","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "–ö–≤–∞—Ä—Ç–∏—Ä–∞-2 –≤ —Ü–µ–Ω—Ç—Ä–µ","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "–ö–≤–∞—Ä—Ç–∏—Ä–∞-2 –Ω–∞ –æ–∫—Ä–∞–∏–Ω–µ","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "–°—Ç—É–¥–∏—è –≤ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏","description_en": ""}]},
                    {"id": "climate","order": 8,"name_ru": "–ö–ª–∏–º–∞—Ç","name_en": "Climate","palette": [{"score": 10,"colour": "#00C853","description_ru": "–í–µ—á–Ω–∞—è –≤–µ—Å–Ω–∞","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "–ú—è–≥–∫–∞—è –∑–∏–º–∞","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "–•–æ—Ä–æ—à–µ–µ –ª–µ—Ç–æ","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "–ù–µ–≤—ã–Ω–æ—Å–∏–º–æ–µ –ª–µ—Ç–æ","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "–ü—É—Å—Ç—ã–Ω—è","description_en": ""}]},
                    {"id": "money_cushion","order": 9,"name_ru": "–†–∞–∑–º–µ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ø–æ–¥—É—à–∫–∏","name_en": "Financial cushion size","palette": [{"score": 10,"colour": "#00C853","description_ru": "10M ‚Ç¨","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "1M ‚Ç¨","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "5 –ª–µ—Ç —Ç—Ä–∞—Ç","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "2 –≥–æ–¥–∞ —Ç—Ä–∞—Ç","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "1 –≥–æ–¥ —Ç—Ä–∞—Ç","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "–û—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –¥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "–î–æ–ª–≥–∏ –Ω–∞ –≥–æ–¥—ã","description_en": ""}]},
                    {"id": "monthly_expenses","order": 10,"name_ru": "–ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ç—Ä–∞—Ç—ã","name_en": "Monthly expenses","palette": [{"score": 10,"colour": "#00C853","description_ru": "10k ‚Ç¨","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "5k ‚Ç¨","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "–ú–∏—Å–∫–∞ —Ä–∏—Å–∞","description_en": ""}]}
                ],
                "options": []
            }
        }

        // --- INITIALIZATION ---
        // NEW: Load state from localStorage as soon as the page content is loaded.
        document.addEventListener('DOMContentLoaded', async () => {
            await loadState();
            document.getElementById('language-switcher').value = state.lang;
        });

    </script>
</body>
</html>
