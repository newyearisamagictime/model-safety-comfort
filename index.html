<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Life Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Inter', 'SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                        'mono': ['SF Mono', 'Monaco', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 20px rgba(99, 102, 241, 0.2)' },
                            '100%': { boxShadow: '0 0 40px rgba(99, 102, 241, 0.4)' },
                        },
                    },
                    backdropBlur: {
                        xs: '2px',
                    },
                    boxShadow: {
                        'glass': '0 8px 32px rgba(31, 38, 135, 0.37)',
                        'glow': '0 0 30px rgba(99, 102, 241, 0.3)',
                        'inner-glow': 'inset 0 1px 0 rgba(255, 255, 255, 0.1)',
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            /* Quantum Design System Variables */
            --quantum-bg-primary: #0a0a0f;
            --quantum-bg-secondary: #121218;
            --quantum-bg-tertiary: #1a1a24;
            --quantum-surface: rgba(255, 255, 255, 0.02);
            --quantum-surface-elevated: rgba(255, 255, 255, 0.05);
            --quantum-border: rgba(255, 255, 255, 0.08);
            --quantum-border-active: rgba(99, 102, 241, 0.3);
            
            /* Neural Network Gradients */
            --neural-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --neural-secondary: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #6366f1 100%);
            --neural-accent: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            --neural-danger: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            
            /* Typography Scale */
            --font-display: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            
            /* Adaptive Color Tokens */
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            --text-accent: #a855f7;
            
            /* Glass Morphism */
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            
            /* Motion Tokens */
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-sharp: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Base Layer: Foundation */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-family: var(--font-body);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        body {
            background: radial-gradient(ellipse at top, #1a1a2e 0%, #0a0a0f 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Ambient Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 25% 25%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        /* Glass Morphism System */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .glass-elevated {
            background: var(--quantum-surface-elevated);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Neural Button System */
        .neural-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
            cursor: pointer;
            transition: all 0.3s var(--ease-smooth);
            overflow: hidden;
            background: var(--neural-primary);
            color: white;
            box-shadow: 
                0 4px 16px rgba(99, 102, 241, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .neural-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .neural-btn:hover::before {
            left: 100%;
        }

        .neural-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 32px rgba(99, 102, 241, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .neural-btn:active {
            transform: translateY(-1px);
        }

        .neural-btn-secondary {
            background: var(--neural-secondary);
            box-shadow: 
                0 4px 16px rgba(6, 182, 212, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .neural-btn-secondary:hover {
            box-shadow: 
                0 8px 32px rgba(6, 182, 212, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .neural-btn-accent {
            background: var(--neural-accent);
            box-shadow: 
                0 4px 16px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .neural-btn-accent:hover {
            box-shadow: 
                0 8px 32px rgba(16, 185, 129, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .neural-btn-danger {
            background: var(--neural-danger);
            box-shadow: 
                0 4px 16px rgba(239, 68, 68, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .neural-btn-danger:hover {
            box-shadow: 
                0 8px 32px rgba(239, 68, 68, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .neural-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Quantum Input System */
        .quantum-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--quantum-surface);
            border: 2px solid var(--quantum-border);
            border-radius: 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s var(--ease-smooth);
            outline: none;
            backdrop-filter: blur(8px);
        }

        .quantum-input::placeholder {
            color: var(--text-tertiary);
        }

        .quantum-input:focus {
            border-color: var(--quantum-border-active);
            background: var(--quantum-surface-elevated);
            box-shadow: 
                0 0 0 4px rgba(99, 102, 241, 0.1),
                0 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* Adaptive Table System */
        .nexus-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: transparent;
        }

        .nexus-table th {
            background: var(--quantum-bg-tertiary);
            padding: 1rem 0.75rem;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-accent);
            border-bottom: 2px solid var(--quantum-border-active);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(20px);
        }

        .nexus-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--quantum-border);
            transition: all 0.3s var(--ease-smooth);
            position: relative;
        }

        .nexus-table tbody tr {
            background: var(--quantum-surface);
            transition: all 0.3s var(--ease-smooth);
        }

        .nexus-table tbody tr:hover {
            background: var(--quantum-surface-elevated);
            transform: translateZ(0);
        }

        .nexus-table tbody tr:hover td {
            border-color: var(--quantum-border-active);
        }

        /* Sticky Column Enhancements */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 5;
            backdrop-filter: blur(20px);
        }

        .sticky-col-header {
            position: sticky;
            left: 0;
            z-index: 15;
            backdrop-filter: blur(20px);
        }

        /* Score Cell Interactive System */
        .score-cell {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .score-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .score-cell:hover::before {
            opacity: 1;
        }

        .score-cell .score-input {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--quantum-border-active);
            border-radius: 0.5rem;
            color: inherit;
            font-weight: 600;
            text-align: center;
            outline: none;
            width: 100%;
            height: 100%;
            padding: 0.5rem;
        }

        .score-cell.editing .score-text {
            display: none;
        }

        .score-cell.editing .score-input {
            display: block;
        }

        /* Modern Scrollbar */
        .quantum-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .quantum-scroll::-webkit-scrollbar-track {
            background: var(--quantum-surface);
            border-radius: 4px;
        }

        .quantum-scroll::-webkit-scrollbar-thumb {
            background: var(--neural-primary);
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .quantum-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--neural-secondary);
            background-clip: padding-box;
        }

        /* Toast Notification System */
        .quantum-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            font-weight: 500;
            box-shadow: var(--glass-shadow);
            z-index: 1000;
            opacity: 0;
            transition: all 0.5s var(--ease-elastic);
            pointer-events: none;
        }

        .quantum-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Modal System */
        .quantum-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--ease-smooth);
        }

        .quantum-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .quantum-modal-content {
            background: var(--quantum-bg-secondary);
            border: 1px solid var(--quantum-border);
            border-radius: 1.5rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 
                0 32px 128px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s var(--ease-elastic);
        }

        .quantum-modal.show .quantum-modal-content {
            transform: scale(1) translateY(0);
        }

        /* Animation Classes */
        .fade-in-up {
            animation: slideUp 0.6s var(--ease-smooth);
        }

        .pulse-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        .float {
            animation: float 6s ease-in-out infinite;
        }

        /* Enhanced Icons */
        .quantum-icon {
            width: 1.25rem;
            height: 1.25rem;
            stroke-width: 2;
            transition: all 0.3s var(--ease-smooth);
        }

        .quantum-icon:hover {
            transform: scale(1.1);
        }

        /* Content Editable Enhancements */
        [contenteditable="true"]:focus {
            outline: 2px solid var(--quantum-border-active);
            outline-offset: 2px;
            border-radius: 0.25rem;
        }

        /* Empty State Illustrations */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            text-align: center;
        }

        .empty-state-icon {
            width: 4rem;
            height: 4rem;
            color: var(--text-tertiary);
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            color: var(--text-tertiary);
            max-width: 24rem;
        }

        /* Table Container with Advanced Glass Effect */
        .table-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Actions Column */
        .actions-column {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%) !important;
            backdrop-filter: blur(10px);
        }

        /* Advanced Hover Effects */
        .hover-lift {
            transition: all 0.3s var(--ease-smooth);
        }

        .hover-lift:hover {
            transform: translateY(-2px) translateZ(0);
        }

        /* Parameter Editor Specific Styles */
        .param-item {
            background: var(--quantum-surface);
            border: 1px solid var(--quantum-border);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s var(--ease-smooth);
        }

        .param-item:hover {
            border-color: var(--quantum-border-active);
            background: var(--quantum-surface-elevated);
        }

        /* Color Picker Enhancement */
        input[type="color"] {
            width: 2.5rem;
            height: 2.5rem;
            border: 2px solid var(--quantum-border);
            border-radius: 0.5rem;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s var(--ease-smooth);
        }

        input[type="color"]:hover {
            border-color: var(--quantum-border-active);
            transform: scale(1.05);
        }

        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 2s infinite;
        }

        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .neural-btn {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
            
            .nexus-table th,
            .nexus-table td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .quantum-modal-content {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
            }
        }

        /* Dark Mode Optimizations */
        @media (prefers-color-scheme: dark) {
            :root {
                --text-primary: #ffffff;
                --text-secondary: #a1a1aa;
                --text-tertiary: #71717a;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --quantum-border: rgba(255, 255, 255, 0.3);
                --quantum-border-active: rgba(99, 102, 241, 0.8);
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="quantum-scroll">
    <!-- Ambient Particles Background -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-2 h-2 bg-blue-400 rounded-full opacity-20 animate-float"></div>
        <div class="absolute top-3/4 right-1/4 w-1 h-1 bg-purple-400 rounded-full opacity-30 float" style="animation-delay: 2s;"></div>
        <div class="absolute top-1/2 left-3/4 w-3 h-3 bg-pink-400 rounded-full opacity-10 float" style="animation-delay: 4s;"></div>
    </div>

    <div id="app" class="relative z-10 container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        
        <!-- Revolutionary Header -->
        <header class="mb-12 fade-in-up">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
                <!-- Brand Identity -->
                <div class="flex items-center space-x-6">
                    <div class="relative">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center pulse-glow">
                            <i data-lucide="brain-circuit" class="quantum-icon w-8 h-8 text-white"></i>
                        </div>
                        <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl blur opacity-30 animate-pulse"></div>
                    </div>
                    <div>
                        <h1 class="text-4xl md:text-5xl font-black bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent leading-tight">
                            Nexus Life Intelligence
                        </h1>
                        <p class="text-gray-400 font-medium mt-1">Quantum Decision Matrix™</p>
                    </div>
                </div>
                
                <!-- Action Bar -->
                <div class="flex items-center flex-wrap gap-3">
                    <button id="transpose-btn" class="neural-btn hover-lift group">
                        <i data-lucide="rotate-cw" class="quantum-icon group-hover:rotate-180 transition-transform duration-500"></i>
                        <span data-lang-key="transpose_table">Matrix View</span>
                    </button>
                    <button id="edit-params-btn" class="neural-btn neural-btn-secondary hover-lift">
                        <i data-lucide="sliders-horizontal" class="quantum-icon"></i>
                        <span data-lang-key="edit_parameters">Parameters</span>
                    </button>
                    <button id="export-btn" class="neural-btn neural-btn-accent hover-lift">
                        <i data-lucide="download" class="quantum-icon"></i>
                        <span data-lang-key="export_json">Export</span>
                    </button>
                    <label for="import-file" class="neural-btn neural-btn-accent hover-lift cursor-pointer">
                        <i data-lucide="upload" class="quantum-icon"></i>
                        <span data-lang-key="import_json">Import</span>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                    </label>
                </div>
            </div>
        </header>

        <!-- Intelligent Search -->
        <div class="mb-8 fade-in-up" style="animation-delay: 0.1s;">
            <div class="relative max-w-md">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="quantum-icon text-gray-400"></i>
                </div>
                <input 
                    id="search-box" 
                    type="text" 
                    placeholder="Search scenarios & parameters..." 
                    data-lang-placeholder="filter_options" 
                    class="quantum-input pl-12 pr-4"
                >
                <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10 pointer-events-none opacity-0 transition-opacity duration-300" id="search-glow"></div>
            </div>
        </div>

        <!-- Revolutionary Data Table -->
        <div id="table-container" class="table-container mb-8 fade-in-up quantum-scroll" style="animation-delay: 0.2s;">
            <table id="main-table" class="nexus-table">
                <thead id="table-header">
                    <!-- Dynamic header generation -->
                </thead>
                <tbody id="table-body">
                    <!-- Dynamic body generation -->
                </tbody>
            </table>
        </div>
        
        <!-- Quick Actions -->
        <div class="fade-in-up" style="animation-delay: 0.3s;">
            <button id="add-option-btn" class="neural-btn neural-btn-accent hover-lift group">
                <i data-lucide="plus" class="quantum-icon group-hover:rotate-90 transition-transform duration-300"></i>
                <span data-lang-key="add_option">Add Scenario</span>
            </button>
        </div>

    </div>

    <!-- Quantum Parameter Editor Modal -->
    <div id="param-editor-modal" class="quantum-modal">
        <div class="quantum-modal-content w-full max-w-6xl mx-4">
            <!-- Modal Header -->
            <div class="p-8 border-b border-gray-700/50">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                            <i data-lucide="settings" class="quantum-icon text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent" data-lang-key="parameter_editor">
                                Parameter Matrix
                            </h3>
                            <p class="text-gray-400 text-sm mt-1">Configure evaluation criteria and scoring scales</p>
                        </div>
                    </div>
                    <button id="close-modal-btn" class="w-10 h-10 rounded-xl bg-gray-700/50 hover:bg-gray-600/50 flex items-center justify-center transition-colors">
                        <i data-lucide="x" class="quantum-icon"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="p-8">
                <div id="param-list" class="space-y-8 max-h-[60vh] overflow-y-auto quantum-scroll pr-4">
                    <!-- Dynamic parameter items -->
                </div>
                
                <!-- Modal Actions -->
                <div class="mt-8 flex justify-between items-center pt-6 border-t border-gray-700/50">
                    <button id="add-param-btn" class="neural-btn neural-btn-accent hover-lift">
                        <i data-lucide="plus-circle" class="quantum-icon"></i>
                        <span data-lang-key="add_parameter">Add Parameter</span>
                    </button>
                    <button id="save-params-btn" class="neural-btn hover-lift">
                        <i data-lucide="save" class="quantum-icon"></i>
                        <span data-lang-key="save_and_close">Save Changes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quantum Toast System -->
    <div id="toast" class="quantum-toast"></div>

    <script type="module">
        // Initialize Lucide icons
        lucide.createIcons();
        // --- DATA AND STATE MANAGEMENT ---
        const state = {
            lang: 'ru', // Default to Russian
            isTransposed: false,
            parameters: [],
            options: [],
            colorMap: new Map(),
            descriptionMap: new Map(),
        };

        const i18n = {
            en: {
                edit_parameters: "Parameters",
                export_json: "Export",
                import_json: "Import",
                transpose_table: "Matrix View",
                filter_options: "Search scenarios & parameters...",
                option_name: "Scenario",
                notes_price: "Notes / Context",
                actions: "Actions",
                add_option: "Add Scenario",
                parameter_editor: "Parameter Matrix",
                add_parameter: "Add Parameter",
                save_and_close: "Save Changes",
                delete: "Delete",
                clone: "Clone",
                score: "Score",
                color: "Color",
                description: "Description",
                parameter_name: "Parameter Name",
                parameter: "Parameter",
                new_option_name: "New Scenario",
                new_option_notes: "Context notes...",
                new_parameter_name: "New Parameter",
                default_palette_desc: "Description for score",
                import_success: "Data imported successfully!",
                import_error: "Failed to read or parse JSON file.",
                changes_saved: "Changes saved automatically.",
                no_params_title: "No Parameters Configured",
                no_params_text: "Click 'Parameters' to configure your evaluation criteria.",
                no_options_title: "No Scenarios Found",
                no_options_text: "Click 'Add Scenario' to create your first life option.",
            },
            ru: {
                edit_parameters: "Параметры",
                export_json: "Экспорт",
                import_json: "Импорт",
                transpose_table: "Матрица",
                filter_options: "Поиск сценариев и параметров...",
                option_name: "Сценарий",
                notes_price: "Заметки / Контекст",
                actions: "Действия",
                add_option: "Добавить сценарий",
                parameter_editor: "Матрица параметров",
                add_parameter: "Добавить параметр",
                save_and_close: "Сохранить изменения",
                delete: "Удалить",
                clone: "Клонировать",
                score: "Оценка",
                color: "Цвет",
                description: "Описание",
                parameter_name: "Название параметра",
                parameter: "Параметр",
                new_option_name: "Новый сценарий",
                new_option_notes: "Заметки о контексте...",
                new_parameter_name: "Новый параметр",
                default_palette_desc: "Описание для оценки",
                import_success: "Данные успешно импортированы!",
                import_error: "Не удалось прочитать или обработать JSON файл.",
                changes_saved: "Изменения сохранены автоматически.",
                no_params_title: "Параметры не настроены",
                no_params_text: "Нажмите 'Параметры', чтобы настроить критерии оценки.",
                no_options_title: "Сценарии не найдены",
                no_options_text: "Нажмите 'Добавить сценарий', чтобы создать первый вариант жизни.",
            }
        };

        const getLangString = (key) => i18n[state.lang][key] || key;
        
        const updateUIText = () => {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (i18n[state.lang] && i18n[state.lang][key]) {
                    el.textContent = i18n[state.lang][key];
                }
            });
             document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (i18n[state.lang] && i18n[state.lang][key]) {
                    el.placeholder = i18n[state.lang][key];
                }
            });
            renderTable();
        };
        
        // --- Utility Functions ---

        // Enhanced toast notification with quantum design
        const showToast = (messageKey) => {
            const toast = document.getElementById('toast');
            toast.textContent = getLangString(messageKey);
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        };

        // NEW: Эта функция сохраняет все текущие данные (параметры и опции) в localStorage браузера.
        const saveState = () => { 
            try { 
                localStorage.setItem('gemini.parameters', JSON.stringify(state.parameters)); 
                localStorage.setItem('gemini.options', JSON.stringify(state.options)); 
            } catch (e) { 
                console.error("Error saving to localStorage:", e); 
            } 
        };

        // NEW: Эта функция загружает данные из localStorage при запуске приложения.
        // Если сохраненных данных нет, она использует начальные данные.
        const loadState = async () => {
            const savedLang = localStorage.getItem('gemini.lang'); 
            if (savedLang) state.lang = savedLang;

            const savedParams = localStorage.getItem('gemini.parameters'); 
            const savedOptions = localStorage.getItem('gemini.options');

            if (savedParams && savedOptions) { 
                state.parameters = JSON.parse(savedParams); 
                state.options = JSON.parse(savedOptions); 
            } else { 
                const d = getInitialData(); 
                state.parameters = d.parameters; 
                state.options = d.options; 
            }
            state.parameters.sort((a, b) => a.order - b.order); 
            rebuildMappings(); 
            updateUIText();
        };

        const rebuildMappings = () => {
            state.colorMap.clear(); state.descriptionMap.clear(); const descKey = `description_${state.lang}`;
            for (const param of state.parameters) {
                const paramColorMap = new Map(); const paramDescMap = new Map(); const sortedPalette = [...param.palette].sort((a,b) => b.score - a.score);
                for (const p of sortedPalette) { paramColorMap.set(p.score, p.colour); const d = p[descKey] || p.description_en; if(d) { paramDescMap.set(p.score, d); } }
                state.colorMap.set(param.id, paramColorMap); state.descriptionMap.set(param.id, paramDescMap);
            }
        };

        function getDescriptionForScore(paramId, score) {
            if (score === null || score === undefined || score === '') return ''; const numericScore = Number(score);
            const paramDescMap = state.descriptionMap.get(paramId); if (!paramDescMap) return String(score); if (paramDescMap.has(numericScore)) { return paramDescMap.get(numericScore); }
            let prevDesc = null; let nextDesc = null;
            for (let i = numericScore - 1; i >= 1; i--) { if (paramDescMap.has(i)) { prevDesc = paramDescMap.get(i); break; } }
            for (let i = numericScore + 1; i <= 10; i++) { if (paramDescMap.has(i)) { nextDesc = paramDescMap.get(i); break; } }
            if (prevDesc && nextDesc) return `> ${prevDesc}, < ${nextDesc}`; if (prevDesc) return `> ${prevDesc}`; if (nextDesc) return `< ${nextDesc}`; return String(score);
        }

        function calculateAverageScore(option) {
            const scores = Object.values(option.scores).filter(score => score !== '' && score !== null && score !== undefined);
            if (scores.length === 0) return null;
            const sum = scores.reduce((acc, score) => acc + Number(score), 0);
            return Math.round(sum / scores.length);
        }

        function getColorForAverageScore(averageScore) {
            if (averageScore === null || state.parameters.length === 0) return '#FFFFFF';
            const firstParam = state.parameters[0];
            const colorMap = state.colorMap.get(firstParam.id);
            if (!colorMap) return '#FFFFFF';
            return colorMap.get(averageScore) || '#FFFFFF';
        }

        // --- RENDERING LOGIC (Unchanged) ---

        function renderTable() {
            const table = document.getElementById('main-table');
            const header = document.getElementById('table-header');
            const body = document.getElementById('table-body');
            
            table.className = `w-full text-left ${state.isTransposed ? 'transposed-table' : 'standard-table'}`;

            if (state.isTransposed) {
                renderTransposedHeader(header);
                renderTransposedBody(body);
            } else {
                renderStandardHeader(header);
                renderStandardBody(body);
            }
            if (state.parameters.length === 0) {
                 body.innerHTML = `<tr><td colspan="3" class="text-center p-12">
                     <div class="empty-state">
                         <i data-lucide="settings" class="empty-state-icon"></i>
                         <h3 class="empty-state-title">${getLangString('no_params_title')}</h3>
                         <p class="empty-state-description">${getLangString('no_params_text')}</p>
                     </div>
                 </td></tr>`;
                 lucide.createIcons();
            }
        }

        function renderStandardHeader(header) {
            const nameKey = `name_${state.lang}`;
            let headerHTML = '<tr>';
            headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left sticky-col-header bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">${getLangString('option_name')}</th>`;
            headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">${getLangString('notes_price')}</th>`;
            state.parameters.forEach(param => {
                headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">${param[nameKey] || param.name_en}</th>`;
            });
            headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-center bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">${getLangString('actions')}</th>`;
            headerHTML += '</tr>';
            header.innerHTML = headerHTML;
        }

        function renderStandardBody(body) {
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));

            if (state.parameters.length > 0 && filteredOptions.length === 0) {
                 body.innerHTML = `<tr><td colspan="${state.parameters.length + 3}" class="text-center p-12">
                     <div class="empty-state">
                         <i data-lucide="database" class="empty-state-icon"></i>
                         <h3 class="empty-state-title">${getLangString('no_options_title')}</h3>
                         <p class="empty-state-description">${getLangString('no_options_text')}</p>
                     </div>
                 </td></tr>`;
                 lucide.createIcons();
                 return;
            }

            let bodyHTML = '';
            filteredOptions.forEach((option, optionIndex) => {
                const actualIndex = state.options.findIndex(o => o.id === option.id);
                const averageScore = calculateAverageScore(option);
                const rowColor = getColorForAverageScore(averageScore);
                const textColor = getContrastTextColor(rowColor);
                bodyHTML += `<tr class="hover:bg-opacity-80 border-b border-gray-700 transition-all duration-200" data-option-id="${option.id}" style="background-color: ${rowColor};">`;
                const averageScoreText = averageScore !== null ? ` (${averageScore})` : '';
                bodyHTML += `<td class="p-4 text-sm font-medium sticky-col" contenteditable="true" data-field="title" style="background-color: ${rowColor}; color: #ffffff;">
                    <span class="option-title">${option.title}</span><span class="average-score text-purple-300 font-bold">${averageScoreText}</span>
                </td>`;
                bodyHTML += `<td class="p-4 text-xs font-medium" contenteditable="true" data-field="price" style="background-color: ${rowColor}; color: ${textColor};">${option.price}</td>`;
                state.parameters.forEach((param, paramIndex) => {
                    const score = option.scores[param.id] || '';
                    const color = state.colorMap.get(param.id)?.get(Number(score)) || 'rgba(26, 26, 46, 0.6)';
                    const textColor = getContrastTextColor(color);
                    const displayText = getDescriptionForScore(param.id, score);
                    bodyHTML += `
                        <td class="p-0 text-center score-cell transition-all duration-200" style="background-color: ${color}; color: ${textColor};" 
                            data-option-id="${option.id}" data-param-id="${param.id}" 
                            data-option-index="${optionIndex}" data-param-index="${paramIndex}">
                            <span class="score-text p-4 block cursor-pointer text-xs h-full hover:bg-black hover:bg-opacity-20" style="color: ${textColor};">${displayText}</span>
                            <input type="number" min="1" max="10" value="${score}" class="score-input w-full h-full p-4 bg-transparent text-center font-semibold focus:outline-none focus:ring-2 focus:ring-purple-500" style="color: ${textColor};">
                        </td>`;
                });
                bodyHTML += `<td class="p-4 text-center actions-column" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%) !important;">
                    <div class="flex items-center justify-center space-x-2">
                        <button class="text-blue-400 hover:text-blue-300 move-up-btn transition-colors group" data-option-id="${option.id}" title="Move up" ${actualIndex === 0 ? 'disabled' : ''}>
                            <i data-lucide="chevron-up" class="quantum-icon group-hover:-translate-y-0.5 transition-transform"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 move-down-btn transition-colors group" data-option-id="${option.id}" title="Move down" ${actualIndex === state.options.length - 1 ? 'disabled' : ''}>
                            <i data-lucide="chevron-down" class="quantum-icon group-hover:translate-y-0.5 transition-transform"></i>
                        </button>
                        <button class="text-emerald-400 hover:text-emerald-300 clone-option-btn transition-colors group" data-option-id="${option.id}" title="Clone">
                            <i data-lucide="copy" class="quantum-icon group-hover:scale-110 transition-transform"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300 delete-option-btn transition-colors group" data-option-id="${option.id}" title="Delete">
                            <i data-lucide="trash-2" class="quantum-icon group-hover:scale-110 transition-transform"></i>
                        </button>
                    </div>
                </td>`;
                bodyHTML += '</tr>';
            });
            body.innerHTML = bodyHTML;
            lucide.createIcons();
        }

        function renderTransposedHeader(header) {
            let headerHTML = '<tr>';
            headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left sticky-col-header bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">${getLangString('parameter')}</th>`;
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));

            filteredOptions.forEach(option => {
                headerHTML += `<th class="p-4 text-xs font-bold tracking-wider text-left bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">${option.title}</th>`;
            });
            headerHTML += '</tr>';
            header.innerHTML = headerHTML;
        }

        function renderTransposedBody(body) {
            const nameKey = `name_${state.lang}`;
            const filterText = document.getElementById('search-box').value.toLowerCase();
            const filteredOptions = state.options.filter(opt => opt.title.toLowerCase().includes(filterText));
            
            if (state.parameters.length > 0 && filteredOptions.length === 0) {
                 body.innerHTML = `<tr><td colspan="${state.parameters.length + 1}" class="text-center p-12">
                     <div class="empty-state">
                         <i data-lucide="database" class="empty-state-icon"></i>
                         <h3 class="empty-state-title">${getLangString('no_options_title')}</h3>
                         <p class="empty-state-description">${getLangString('no_options_text')}</p>
                     </div>
                 </td></tr>`;
                 lucide.createIcons();
                 return;
            }

            let bodyHTML = '';
            state.parameters.forEach((param, paramIndex) => {
                bodyHTML += `<tr class="hover:bg-opacity-80 border-b border-gray-700 transition-all duration-200" data-param-id="${param.id}">`;
                bodyHTML += `<td class="p-4 text-sm font-medium sticky-col">${param[nameKey] || param.name_en}</td>`;
                filteredOptions.forEach((option, optionIndex) => {
                    const score = option.scores[param.id] || '';
                    const color = state.colorMap.get(param.id)?.get(Number(score)) || 'rgba(26, 26, 46, 0.6)';
                    const textColor = getContrastTextColor(color);
                    const displayText = getDescriptionForScore(param.id, score);
                    bodyHTML += `
                        <td class="p-0 text-center score-cell transition-all duration-200" style="background-color: ${color}; color: ${textColor};" 
                            data-option-id="${option.id}" data-param-id="${param.id}" 
                            data-option-index="${optionIndex}" data-param-index="${paramIndex}">
                            <span class="score-text p-4 block cursor-pointer text-xs h-full hover:bg-black hover:bg-opacity-20" style="color: ${textColor};">${displayText}</span>
                            <input type="number" min="1" max="10" value="${score}" class="score-input w-full h-full p-4 bg-transparent text-center font-semibold focus:outline-none focus:ring-2 focus:ring-purple-500" style="color: ${textColor};">
                        </td>`;
                });
                bodyHTML += `</tr>`;
            });
            body.innerHTML = bodyHTML;
            lucide.createIcons();
        }

        const renderParamEditor = () => {
            const paramList = document.getElementById('param-list'); 
            paramList.innerHTML = '';
            const nameKey = `name_${state.lang}`; 
            const descKey = `description_${state.lang}`;
            
            state.parameters.forEach((param, paramIndex) => {
                const paramDiv = document.createElement('div'); 
                paramDiv.className = 'param-item'; 
                paramDiv.dataset.paramId = param.id;
                
                let paletteHTML = ''; 
                const sortedPalette = [...param.palette].sort((a, b) => b.score - a.score);
                
                sortedPalette.forEach(p => { 
                    paletteHTML += `
                    <div class="grid grid-cols-12 gap-4 items-center mb-4 group">
                        <div class="col-span-1 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold text-sm">${p.score}</span>
                        </div>
                        <div class="col-span-2">
                            <input type="color" value="${p.colour}" data-score="${p.score}" data-field="colour" class="w-full h-12 border-2 border-gray-600 rounded-xl cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:scale-105">
                        </div>
                        <div class="col-span-9">
                            <input type="text" value="${p[descKey] || p.description_en || ''}" data-score="${p.score}" data-field="description" class="quantum-input text-sm">
                        </div>
                    </div>`; 
                });
                
                paramDiv.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col gap-2">
                            <button class="text-gray-400 hover:text-indigo-400 move-param-up-btn transition-colors group" data-param-id="${param.id}" title="Move up" ${paramIndex === 0 ? 'disabled' : ''}>
                                <i data-lucide="arrow-up" class="quantum-icon group-hover:-translate-y-0.5 transition-transform"></i>
                            </button>
                            <button class="text-gray-400 hover:text-indigo-400 move-param-down-btn transition-colors group" data-param-id="${param.id}" title="Move down" ${paramIndex === state.parameters.length - 1 ? 'disabled' : ''}>
                                <i data-lucide="arrow-down" class="quantum-icon group-hover:translate-y-0.5 transition-transform"></i>
                            </button>
                        </div>
                        <input type="text" value="${param[nameKey] || param.name_en}" data-field="name" class="text-xl font-bold bg-transparent border-b-2 border-transparent focus:border-indigo-500 focus:outline-none flex-1 mx-4 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent placeholder-gray-500" placeholder="Parameter name">
                    </div>
                    <button class="text-red-400 hover:text-red-300 delete-param-btn transition-colors group" data-param-id="${param.id}" title="Delete">
                        <i data-lucide="trash-2" class="quantum-icon group-hover:scale-110 transition-transform"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="grid grid-cols-12 gap-4 text-sm font-bold mb-4 text-gray-400 uppercase tracking-wider">
                        <div class="col-span-1 text-center">${getLangString('score')}</div>
                        <div class="col-span-2">${getLangString('color')}</div>
                        <div class="col-span-9">${getLangString('description')}</div>
                    </div>
                    ${paletteHTML}
                </div>`;
                
                paramList.appendChild(paramDiv);
            });
            lucide.createIcons();
        };

        // --- EVENT HANDLERS ---
        function handleTableInteraction(e) {
            const target = e.target; const optionId = target.closest('[data-option-id]')?.dataset.optionId;
            if (!optionId) return; const option = state.options.find(o => o.id === optionId); if (!option) return;
            if (target.isContentEditable) { 
                // Handle focus event for title editing
                target.addEventListener('focus', () => {
                    if (target.dataset.field === 'title') {
                        const averageSpan = target.querySelector('.average-score');
                        if (averageSpan) averageSpan.style.display = 'none';
                        // Set cursor to edit only the title text
                        const titleSpan = target.querySelector('.option-title');
                        if (titleSpan) {
                            const range = document.createRange();
                            const sel = window.getSelection();
                            range.selectNodeContents(titleSpan);
                            sel.removeAllRanges();
                            sel.addRange(range);
                        }
                    }
                }, { once: true });

                target.addEventListener('blur', () => { 
                    const field = target.dataset.field; 
                    if (field === 'title' || field === 'price') { 
                        if (field === 'title') {
                            // Update only the title part, preserving the structure
                            const titleSpan = target.querySelector('.option-title');
                            if (titleSpan) {
                                option[field] = titleSpan.textContent;
                            } else {
                                // Fallback: extract title from full text (remove average score part)
                                const fullText = target.textContent;
                                const titleText = fullText.replace(/\s*\(\d+\)\s*$/, '');
                                option[field] = titleText;
                            }
                            // Show average score again and update it
                            const averageSpan = target.querySelector('.average-score');
                            if (averageSpan) {
                                averageSpan.style.display = 'inline';
                                const averageScore = calculateAverageScore(option);
                                averageSpan.textContent = averageScore !== null ? ` (${averageScore})` : '';
                            }
                        } else {
                            option[field] = target.textContent;
                        }
                        saveState(); 
                    } 
                }, { once: true }); 
            }
            if (target.closest('.move-up-btn')) {
                const currentIndex = state.options.findIndex(o => o.id === optionId);
                if (currentIndex > 0) {
                    [state.options[currentIndex], state.options[currentIndex - 1]] = [state.options[currentIndex - 1], state.options[currentIndex]];
                    saveState();
                    renderTable();
                }
            }
            if (target.closest('.move-down-btn')) {
                const currentIndex = state.options.findIndex(o => o.id === optionId);
                if (currentIndex < state.options.length - 1) {
                    [state.options[currentIndex], state.options[currentIndex + 1]] = [state.options[currentIndex + 1], state.options[currentIndex]];
                    saveState();
                    renderTable();
                }
            }
            if (target.closest('.clone-option-btn')) { 
                const newId = `option_${Date.now()}`; 
                const clonedOption = { 
                    id: newId, 
                    title: option.title + ' (copy)', 
                    price: option.price, 
                    scores: { ...option.scores } 
                }; 
                const currentIndex = state.options.findIndex(o => o.id === optionId);
                state.options.splice(currentIndex + 1, 0, clonedOption);
                saveState(); 
                renderTable(); 
            }
            if (target.closest('.delete-option-btn')) { state.options = state.options.filter(o => o.id !== optionId); saveState(); renderTable(); }
            const scoreCell = target.closest('.score-cell'); if (scoreCell && !scoreCell.classList.contains('editing')) { scoreCell.classList.add('editing'); const input = scoreCell.querySelector('.score-input'); input.focus(); input.select(); }
        }
        
        function handleScoreInput(e) {
            const input = e.target; if (!input.matches('.score-input')) return; const scoreCell = input.closest('.score-cell'); const { optionId, paramId } = scoreCell.dataset; const option = state.options.find(o => o.id === optionId);
            if (option) { 
                let value = parseInt(input.value, 10); 
                if (isNaN(value)) value = ''; 
                else if (value < 1) value = 1; 
                else if (value > 10) value = 10; 
                input.value = value; 
                option.scores[paramId] = value; 
                const newColor = state.colorMap.get(paramId)?.get(value) || 'rgba(26, 26, 46, 0.6)';
                const textColor = getContrastTextColor(newColor);
                scoreCell.style.backgroundColor = newColor;
                scoreCell.style.color = textColor;
                input.style.color = textColor;
                const scoreText = scoreCell.querySelector('.score-text');
                if (scoreText) scoreText.style.color = textColor;
                
                // Update average score in option title
                const optionRow = document.querySelector(`tr[data-option-id="${optionId}"]`);
                if (optionRow) {
                    const averageSpan = optionRow.querySelector('.average-score');
                    if (averageSpan) {
                        const averageScore = calculateAverageScore(option);
                        averageSpan.textContent = averageScore !== null ? ` (${averageScore})` : '';
                    }
                    // Update row background color based on new average
                    const averageScore = calculateAverageScore(option);
                    const rowColor = getColorForAverageScore(averageScore);
                    optionRow.style.backgroundColor = rowColor;
                    const titleCell = optionRow.querySelector('td[data-field="title"]');
                    const priceCell = optionRow.querySelector('td[data-field="price"]');
                    if (titleCell) titleCell.style.backgroundColor = rowColor;
                    if (priceCell) priceCell.style.backgroundColor = rowColor;
                }
                
                saveState(); 
            }
        }

        function handleScoreBlur(e) {
            const input = e.target; if (!input.matches('.score-input')) return; const scoreCell = input.closest('.score-cell');
            if (scoreCell) { const displayText = getDescriptionForScore(scoreCell.dataset.paramId, input.value); scoreCell.querySelector('.score-text').textContent = displayText; scoreCell.classList.remove('editing'); }
        }
        
        function handleTableKeyDown(e) {
            if (!e.target.matches('.score-input')) return;
            const scoreCell = e.target.closest('.score-cell');
            let { optionIndex, paramIndex } = scoreCell.dataset;
            optionIndex = parseInt(optionIndex);
            paramIndex = parseInt(paramIndex);
            let nextElement = null;
            const move = (d_opt, d_par) => document.querySelector(`[data-option-index="${optionIndex + d_opt}"][data-param-index="${paramIndex + d_par}"]`);
            switch (e.key) {
                case 'ArrowUp': nextElement = state.isTransposed ? move(0, -1) : move(0, -1); break;
                case 'ArrowDown': case 'Enter': nextElement = state.isTransposed ? move(0, 1) : move(0, 1); break;
                case 'ArrowLeft': nextElement = state.isTransposed ? move(-1, 0) : move(-1, 0); break;
                case 'ArrowRight': nextElement = state.isTransposed ? move(1, 0) : move(1, 0); break;
                case 'Escape': e.target.blur(); break;
            }
            if (nextElement) {
                e.preventDefault();
                nextElement.classList.add('editing'); const nextInput = nextElement.querySelector('.score-input'); nextInput.focus(); nextInput.select();
            }
        }
        
        // --- Button Listeners (updates highlighted) ---
        document.getElementById('transpose-btn').addEventListener('click', () => {
            state.isTransposed = !state.isTransposed;
            renderTable();
        });
        
        // NEW: Hotkey handler for transpose (Ctrl+Shift+Q)
        document.addEventListener('keydown', (e) => {
            // Check for Ctrl+Shift+Q (works for both English and Russian layouts)
            if (e.ctrlKey && e.shiftKey && (e.code === 'KeyQ')) {
                e.preventDefault();
                state.isTransposed = !state.isTransposed;
                renderTable();
            }
        });
        
        // Enhanced modal system
        document.getElementById('edit-params-btn').addEventListener('click', () => { 
            renderParamEditor(); 
            const modal = document.getElementById('param-editor-modal');
            modal.classList.add('show');
        });
        
        document.getElementById('close-modal-btn').addEventListener('click', () => { 
            const modal = document.getElementById('param-editor-modal');
            modal.classList.remove('show');
        });
        
        // Enhanced save with visual feedback
        document.getElementById('save-params-btn').addEventListener('click', () => { 
            state.parameters.sort((a, b) => a.order - b.order); 
            rebuildMappings(); 
            saveState(); 
            renderTable(); 
            const modal = document.getElementById('param-editor-modal');
            modal.classList.remove('show');
        });
        
        document.getElementById('add-param-btn').addEventListener('click', () => {
            const newId = `param_${Date.now()}`; const newOrder = state.parameters.length > 0 ? Math.max(...state.parameters.map(p => p.order)) + 1 : 1;
            const defaultColors = ["#00C853", "#1BCB3F", "#64DD17", "#C6FF00", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#F44336", "#D50000"];
            const newParam = { id: newId, order: newOrder, name_ru: getLangString('new_parameter_name'), name_en: getLangString('new_parameter_name'), palette: Array.from({ length: 10 }, (_, i) => ({ score: 10 - i, colour: defaultColors[i], description_en: ``, description_ru: `` })) };
            state.parameters.push(newParam); renderParamEditor();
        });
        
        // NEW: Adding an option now saves the state immediately
        document.getElementById('add-option-btn').addEventListener('click', () => {
            const newId = `option_${Date.now()}`; const newOption = { id: newId, title: getLangString('new_option_name'), price: getLangString('new_option_notes'), scores: {} };
            state.options.push(newOption); saveState(); renderTable();
        });
        
        const tableBody = document.getElementById('table-body');
        tableBody.addEventListener('click', handleTableInteraction);
        tableBody.addEventListener('input', handleScoreInput);
        tableBody.addEventListener('focusout', handleScoreBlur);
        tableBody.addEventListener('keydown', handleTableKeyDown);

        // Enhanced search with live visual feedback
        const searchBox = document.getElementById('search-box');
        const searchGlow = document.getElementById('search-glow');
        
        searchBox.addEventListener('input', () => {
            if (searchBox.value.length > 0) {
                searchGlow.style.opacity = '1';
            } else {
                searchGlow.style.opacity = '0';
            }
            renderTable();
        });
        
        searchBox.addEventListener('focus', () => {
            searchGlow.style.opacity = '1';
        });
        
        searchBox.addEventListener('blur', () => {
            if (searchBox.value.length === 0) {
                searchGlow.style.opacity = '0';
            }
        });
        
        document.getElementById('param-list').addEventListener('input', (e) => {
             const t = e.target; const pDiv = t.closest('[data-param-id]'); if (!pDiv) return; const pId = pDiv.dataset.paramId; const p = state.parameters.find(p => p.id === pId); if (!p) return; const f = t.dataset.field;
             if (f === 'name') { p[`name_${state.lang}`] = t.value; } else if(f === 'colour' || f === 'description') { const s = parseInt(t.dataset.score, 10); const pItem = p.palette.find(p => p.score === s); if(pItem) { if(f === 'colour') pItem.colour = t.value; else pItem[`description_${state.lang}`] = t.value; } }
             rebuildMappings();
        });
        
        document.getElementById('param-list').addEventListener('click', (e) => {
            if(e.target.closest('.move-param-up-btn')) {
                const paramId = e.target.closest('.move-param-up-btn').dataset.paramId;
                const currentIndex = state.parameters.findIndex(p => p.id === paramId);
                if (currentIndex > 0) {
                    // Swap with previous parameter
                    [state.parameters[currentIndex], state.parameters[currentIndex - 1]] = [state.parameters[currentIndex - 1], state.parameters[currentIndex]];
                    // Update order values
                    state.parameters[currentIndex - 1].order = currentIndex;
                    state.parameters[currentIndex].order = currentIndex + 1;
                    rebuildMappings();
                    renderParamEditor();
                }
            }
            if(e.target.closest('.move-param-down-btn')) {
                const paramId = e.target.closest('.move-param-down-btn').dataset.paramId;
                const currentIndex = state.parameters.findIndex(p => p.id === paramId);
                if (currentIndex < state.parameters.length - 1) {
                    // Swap with next parameter
                    [state.parameters[currentIndex], state.parameters[currentIndex + 1]] = [state.parameters[currentIndex + 1], state.parameters[currentIndex]];
                    // Update order values
                    state.parameters[currentIndex].order = currentIndex + 1;
                    state.parameters[currentIndex + 1].order = currentIndex + 2;
                    rebuildMappings();
                    renderParamEditor();
                }
            }
            if(e.target.closest('.delete-param-btn')) { 
                const pId = e.target.closest('.delete-param-btn').dataset.paramId; 
                state.parameters = state.parameters.filter(p => p.id !== pId); 
                state.options.forEach(opt => delete opt.scores[pId]); 
                // Update order values for remaining parameters
                state.parameters.forEach((p, index) => p.order = index + 1);
                renderParamEditor(); 
            }
        });
        
        document.getElementById('export-btn').addEventListener('click', () => {
            const dataToExport = { parameters: state.parameters, options: state.options }; const dataStr = JSON.stringify(dataToExport, null, 2); const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); const date = new Date().toISOString().slice(0, 10).replace(/-/g, ''); a.href = url; a.download = `gemini-data-${date}.json`; a.click(); URL.revokeObjectURL(url);
        });
        
        document.getElementById('import-file').addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.parameters && data.options) { state.parameters = data.parameters; state.options = data.options; state.parameters.sort((a, b) => a.order - b.order); saveState(); rebuildMappings(); updateUIText(); showToast('import_success'); } else { showToast('import_error'); }
                } catch (err) { console.error("Import error:", err); showToast('import_error'); }
            };
            reader.readAsText(file); event.target.value = '';
        });
        
        // --- INITIAL DATA (Unchanged) ---
        function getInitialData() {
            return {
                "parameters": [
                    {"id": "safety_global","order": 1,"name_ru": "Безопасность страны в мире","name_en": "Country safety globally","palette": [{"score": 10,"colour": "#00C853","description_ru": "Копибара","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Неуязвимый","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Выпендривается","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "Войну предсказывают","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "Война объявлена","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Война","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "safety_overall","order": 2,"name_ru": "Общая безопасность в стране","name_en": "Overall safety in country","palette": [{"score": 10,"colour": "#00C853","description_ru": "Рай","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Куча шпаны","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Полицейское государство","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "Картели","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Гражданская война","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "safety_personal","order": 3,"name_ru": "Моя безопасность в стране","name_en": "My safety in country","palette": [{"score": 10,"colour": "#00C853","description_ru": "Мы вас любим","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Вы уже как все","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "Интегрируйтесь","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Понаехали","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Вам будет неприятно","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "Гетто","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Мы вас изрежем","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "civil_status","order": 4,"name_ru": "Мой гражданский статус","name_en": "My civil status","palette": [{"score": 10,"colour": "#00C853","description_ru": "Гражданин по рождению","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Гражданин","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "ПМЖ","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "ВНЖ","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Цифровой кочевник","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Рабочая виза","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "3 месяца без визы","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "Беженец","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Нелегал","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "languages","order": 5,"name_ru": "Языки страны","name_en": "Country languages","palette": [{"score": 10,"colour": "#00C853","description_ru": "Русский + английский","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "Английский","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Национальный + английский 50%","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Национальный + английский 20%","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Национальный","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "cost_of_living","order": 6,"name_ru": "Уровень цен","name_en": "Cost of living","palette": [{"score": 10,"colour": "#00C853","description_ru": "Братислава","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "Цюрих","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "","description_en": ""}]},
                    {"id": "housing","order": 7,"name_ru": "Жильё","name_en": "Housing","palette": [{"score": 10,"colour": "#00C853","description_ru": "Вилла в городе","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Дом-5 в городе","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "Квартира-5 в городе","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "Дом-5 за городом","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Квартира-4 на окраине","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Квартира-2 в центре","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "Квартира-2 на окраине","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "Студия в провинции","description_en": ""}]},
                    {"id": "climate","order": 8,"name_ru": "Климат","name_en": "Climate","palette": [{"score": 10,"colour": "#00C853","description_ru": "Вечная весна","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "Мягкая зима","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "Хорошее лето","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "Невыносимое лето","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "Пустыня","description_en": ""}]},
                    {"id": "money_cushion","order": 9,"name_ru": "Размер финансовой подушки","name_en": "Financial cushion size","palette": [{"score": 10,"colour": "#00C853","description_ru": "10M €","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "1M €","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "5 лет трат","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "2 года трат","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "1 год трат","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "От зарплаты до зарплаты","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "Долги на годы","description_en": ""}]},
                    {"id": "monthly_expenses","order": 10,"name_ru": "Ежемесячные траты","name_en": "Monthly expenses","palette": [{"score": 10,"colour": "#00C853","description_ru": "10k €","description_en": ""},{"score": 9,"colour": "#1BCB3F","description_ru": "","description_en": ""},{"score": 8,"colour": "#64DD17","description_ru": "5k €","description_en": ""},{"score": 7,"colour": "#C6FF00","description_ru": "","description_en": ""},{"score": 6,"colour": "#FFEB3B","description_ru": "","description_en": ""},{"score": 5,"colour": "#FFC107","description_ru": "","description_en": ""},{"score": 4,"colour": "#FF9800","description_ru": "","description_en": ""},{"score": 3,"colour": "#FF5722","description_ru": "","description_en": ""},{"score": 2,"colour": "#F44336","description_ru": "","description_en": ""},{"score": 1,"colour": "#D50000","description_ru": "Миска риса","description_en": ""}]}
                ],
                "options": []
            }
        }

        // --- INITIALIZATION ---
        // NEW: Load state from localStorage as soon as the page content is loaded.
        document.addEventListener('DOMContentLoaded', async () => {
            await loadState();
            lucide.createIcons(); // Initialize icons after content is loaded
        });

        // Function to determine if a color is light or dark and return appropriate text color
        function getContrastTextColor(color) {
            // Handle rgba colors
            if (color.startsWith('rgba')) {
                // For rgba colors with transparency, assume dark background
                return '#ffffff';
            }
            
            // Handle hex colors
            if (color.startsWith('#')) {
                const hex = color.replace('#', '');
                
                // Convert hex to RGB
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);
                
                // Calculate luminance using the relative luminance formula
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                
                // Return black text for light backgrounds, white text for dark backgrounds
                return luminance > 0.6 ? '#000000' : '#ffffff';
            }
            
            // Handle rgb colors
            if (color.startsWith('rgb')) {
                const matches = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (matches) {
                    const r = parseInt(matches[1]);
                    const g = parseInt(matches[2]);
                    const b = parseInt(matches[3]);
                    
                    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    return luminance > 0.6 ? '#000000' : '#ffffff';
                }
            }
            
            // Default to white text for unknown color formats
            return '#ffffff';
        }
    </script>
</body>
</html>
